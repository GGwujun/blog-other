<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="/logo.png" />
    <link rel="stylesheet" href="/blog-other/umi.css" />
    <script>
      window.routerBase = "/blog-other";
    </script>
    <script>
      //! umi version: 3.5.41
    </script>
    <script>
      !(function () {
        var e =
            navigator.cookieEnabled && void 0 !== window.localStorage
              ? localStorage.getItem("dumi:prefers-color")
              : "auto",
          o = window.matchMedia("(prefers-color-scheme: dark)").matches,
          t = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === t[2] ? (o ? t[1] : t[0]) : t.indexOf(e) > -1 ? e : t[0]
        );
      })();
    </script>
    <title>实战二｜MQTT开发：如何实现联网控制？ - 大师兄</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/物联网开发实战/01.2022特别加更/03" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-other/">大师兄</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span>前端开发<ul><li><a href="/blog-other/说透低代码">说透低代码</a></li><li><a href="/blog-other/反爬虫兵法演绎20讲">反爬虫兵法演绎20讲</a></li></ul></span><span>产品与用户体验<ul><li><a href="/blog-other/大厂广告产品心法">大厂广告产品心法</a></li></ul></span><span>面试<ul><li><a href="/blog-other/技术面试官识人手册">技术面试官识人手册</a></li><li><a href="/blog-other/面试现场">面试现场</a></li></ul></span><span>杂谈<ul><li><a href="/blog-other/乔新亮的cto成长复盘">乔新亮的cto成长复盘</a></li><li><a href="/blog-other/互联网人的英语私教课">互联网人的英语私教课</a></li><li><a href="/blog-other/从0开始学游戏开发">从0开始学游戏开发</a></li><li><a href="/blog-other/全栈工程师修炼指南">全栈工程师修炼指南</a></li><li><a href="/blog-other/手机摄影">手机摄影</a></li><li><a aria-current="page" class="active" href="/blog-other/物联网开发实战">物联网开发实战</a></li><li><a href="/blog-other/白话法律42讲">白话法律42讲</a></li><li><a href="/blog-other/说透5g">说透5g</a></li><li><a href="/blog-other/超级访谈对话张雪峰">超级访谈对话张雪峰</a></li><li><a href="/blog-other/零基础实战机器学习">零基础实战机器学习</a></li></ul></span><div class="__dumi-default-navbar-tool"><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-other/"></a><h1>大师兄</h1><p></p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li>前端开发<ul><li><a href="/blog-other/说透低代码">说透低代码</a></li><li><a href="/blog-other/反爬虫兵法演绎20讲">反爬虫兵法演绎20讲</a></li></ul></li><li>产品与用户体验<ul><li><a href="/blog-other/大厂广告产品心法">大厂广告产品心法</a></li></ul></li><li>面试<ul><li><a href="/blog-other/技术面试官识人手册">技术面试官识人手册</a></li><li><a href="/blog-other/面试现场">面试现场</a></li></ul></li><li>杂谈<ul><li><a href="/blog-other/乔新亮的cto成长复盘">乔新亮的cto成长复盘</a></li><li><a href="/blog-other/互联网人的英语私教课">互联网人的英语私教课</a></li><li><a href="/blog-other/从0开始学游戏开发">从0开始学游戏开发</a></li><li><a href="/blog-other/全栈工程师修炼指南">全栈工程师修炼指南</a></li><li><a href="/blog-other/手机摄影">手机摄影</a></li><li><a aria-current="page" class="active" href="/blog-other/物联网开发实战">物联网开发实战</a></li><li><a href="/blog-other/白话法律42讲">白话法律42讲</a></li><li><a href="/blog-other/说透5g">说透5g</a></li><li><a href="/blog-other/超级访谈对话张雪峰">超级访谈对话张雪峰</a></li><li><a href="/blog-other/零基础实战机器学习">零基础实战机器学习</a></li></ul></li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a href="/blog-other/物联网开发实战">物联网开发实战</a></li><li><a aria-current="page" class="active" href="/blog-other/物联网开发实战/01.2022特别加更">01.2022特别加更</a><ul><li><a href="/blog-other/物联网开发实战/01.2022特别加更/01"><span>引子｜RISC-V：物联网领域值得关注的芯片趋势是什么？</span></a></li><li><a href="/blog-other/物联网开发实战/01.2022特别加更/02"><span>实战一｜嵌入式开发：如何使用C语言开发智能电灯？</span></a></li><li><a aria-current="page" class="active" href="/blog-other/物联网开发实战/01.2022特别加更/03"><span>实战二｜MQTT开发：如何实现联网控制？</span></a></li><li><a href="/blog-other/物联网开发实战/01.2022特别加更/04"><span>假期快乐｜这是一份暂时停更的声明</span></a></li></ul></li><li><a href="/blog-other/物联网开发实战/02.开篇词">02.开篇词</a><ul><li><a href="/blog-other/物联网开发实战/02.开篇词/01"><span>开篇词 | 物联网这个趋势，你不应该错过</span></a></li></ul></li><li><a href="/blog-other/物联网开发实战/03.基础篇">03.基础篇</a><ul><li><a href="/blog-other/物联网开发实战/03.基础篇/01"><span>01 | 入门介绍：如何定义物联网？</span></a></li><li><a href="/blog-other/物联网开发实战/03.基础篇/02"><span>02 | 通信技术：设备接入网络的方式有哪些？</span></a></li><li><a href="/blog-other/物联网开发实战/03.基础篇/03"><span>03 | 网络协议：设备使用什么语言与互联网对话？</span></a></li><li><a href="/blog-other/物联网开发实战/03.基础篇/04"><span>04 | 数据分析：数据的价值有哪些？</span></a></li><li><a href="/blog-other/物联网开发实战/03.基础篇/05"><span>05 | 系统实例：怎样设计一个简易物联网系统？</span></a></li></ul></li><li><a href="/blog-other/物联网开发实战/04.进阶篇">04.进阶篇</a><ul><li><a href="/blog-other/物联网开发实战/04.进阶篇/01"><span>06 | 物模型：如何定义智能电灯？</span></a></li><li><a href="/blog-other/物联网开发实战/04.进阶篇/02"><span>07 | 零配置组网：设备如何发现彼此？</span></a></li><li><a href="/blog-other/物联网开发实战/04.进阶篇/03"><span>08 | MQTT：在实践中掌握一个通信协议</span></a></li><li><a href="/blog-other/物联网开发实战/04.进阶篇/04"><span>09 | 边缘中心：物联网网关有多重要？</span></a></li><li><a href="/blog-other/物联网开发实战/04.进阶篇/05"><span>10 | 数据处理框架：批处理还是流处理？</span></a></li><li><a href="/blog-other/物联网开发实战/04.进阶篇/06"><span>11 | 数据存储：物联网中的数据库有哪些？</span></a></li><li><a href="/blog-other/物联网开发实战/04.进阶篇/07"><span>12 | IoT Hub：面对海量设备如何打造高性能设备接入层？</span></a></li><li><a href="/blog-other/物联网开发实战/04.进阶篇/08"><span>13 | 隐私：在实践中如何保护用户隐私？</span></a></li><li><a href="/blog-other/物联网开发实战/04.进阶篇/09"><span>14 | 安全：物联网平台如何应对安全风险？</span></a></li><li><a href="/blog-other/物联网开发实战/04.进阶篇/10"><span>15 | 平台：智能家居开源平台的生态是怎样的？</span></a></li></ul></li><li><a href="/blog-other/物联网开发实战/05.实战篇">05.实战篇</a><ul><li><a href="/blog-other/物联网开发实战/05.实战篇/01"><span>16 | 实战准备：如何搭建硬件开发环境？</span></a></li><li><a href="/blog-other/物联网开发实战/05.实战篇/02"><span>17 | 远程控制：怎样打造联网的智能电灯？</span></a></li><li><a href="/blog-other/物联网开发实战/05.实战篇/03"><span>18 | 场景联动：智能电灯如何感知光线？（上）</span></a></li><li><a href="/blog-other/物联网开发实战/05.实战篇/04"><span>19 | 场景联动：智能电灯如何感知光线？（下）</span></a></li><li><a href="/blog-other/物联网开发实战/05.实战篇/05"><span>20 | 智能语音：好玩的语音控制是怎么实现的？</span></a></li><li><a href="/blog-other/物联网开发实战/05.实战篇/06"><span>21 | 多传感器集成：浇花怎么实现自动化？</span></a></li><li><a href="/blog-other/物联网开发实战/05.实战篇/07"><span>22 | 掌控数据：家里的数据可以怎么利用？</span></a></li></ul></li><li><a href="/blog-other/物联网开发实战/06.结束语">06.结束语</a><ul><li><a href="/blog-other/物联网开发实战/06.结束语/01"><span>结束语 | 永远做一个具有极客精神的人</span></a></li></ul></li><li><a href="/blog-other/物联网开发实战/07.测试题">07.测试题</a><ul><li><a href="/blog-other/物联网开发实战/07.测试题/01"><span>结课测试 | 这些物联网的问题，你都掌握了吗？</span></a></li></ul></li><li><a href="/blog-other/物联网开发实战/08.加餐">08.加餐</a><ul><li><a href="/blog-other/物联网开发实战/08.加餐/01"><span>加餐一 | 这5本关于物联网的好书，值得一读</span></a></li><li><a href="/blog-other/物联网开发实战/08.加餐/02"><span>加餐二 | 行业应用：物联网的发展将如何重塑我们的生活？</span></a></li><li><a href="/blog-other/物联网开发实战/08.加餐/03"><span>加餐三 | 行业应用：物联网的发展将如何升级第一、第二产业？</span></a></li><li><a href="/blog-other/物联网开发实战/08.加餐/04"><span>加餐四 | 5G技术将如何推动物联网的发展？</span></a></li><li><a href="/blog-other/物联网开发实战/08.加餐/05"><span>加餐五 | 投身物联网行业，如何做好职业规划？</span></a></li></ul></li><li><a href="/blog-other/物联网开发实战/09.用户故事">09.用户故事</a><ul><li><a href="/blog-other/物联网开发实战/09.用户故事/01"><span>用户故事 | 让野蛮生长成为职业发展的助推剂</span></a></li><li><a href="/blog-other/物联网开发实战/09.用户故事/02"><span>用户故事 | 转战物联网，我相信天道酬勤</span></a></li></ul></li><li><a href="/blog-other/物联网开发实战/summary">物联网开发实战</a></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="生活物联网平台的准备工作" data-depth="2"><a href="/blog-other/物联网开发实战/01.2022特别加更/03#生活物联网平台的准备工作"><span>生活物联网平台的准备工作</span></a></li><li title="创建项目和产品" data-depth="3"><a href="/blog-other/物联网开发实战/01.2022特别加更/03#创建项目和产品"><span>创建项目和产品</span></a></li><li title="产品功能定义" data-depth="3"><a href="/blog-other/物联网开发实战/01.2022特别加更/03#产品功能定义"><span>产品功能定义</span></a></li><li title="人机交互设计" data-depth="3"><a href="/blog-other/物联网开发实战/01.2022特别加更/03#人机交互设计"><span>人机交互设计</span></a></li><li title="设备调试设置" data-depth="3"><a href="/blog-other/物联网开发实战/01.2022特别加更/03#设备调试设置"><span>设备调试设置</span></a></li><li title="智能灯如何接入物联网" data-depth="2"><a href="/blog-other/物联网开发实战/01.2022特别加更/03#智能灯如何接入物联网"><span>智能灯如何接入物联网</span></a></li><li title="联网功能开发" data-depth="3"><a href="/blog-other/物联网开发实战/01.2022特别加更/03#联网功能开发"><span>联网功能开发</span></a></li><li title="智能灯平台交互的封装" data-depth="3"><a href="/blog-other/物联网开发实战/01.2022特别加更/03#智能灯平台交互的封装"><span>智能灯平台交互的封装</span></a></li><li title="LED颜色控制实现" data-depth="3"><a href="/blog-other/物联网开发实战/01.2022特别加更/03#led颜色控制实现"><span>LED颜色控制实现</span></a></li><li title="继电器状态获取实现" data-depth="3"><a href="/blog-other/物联网开发实战/01.2022特别加更/03#继电器状态获取实现"><span>继电器状态获取实现</span></a></li><li title="网络初始化实现" data-depth="3"><a href="/blog-other/物联网开发实战/01.2022特别加更/03#网络初始化实现"><span>网络初始化实现</span></a></li><li title="智能灯主逻辑实现" data-depth="3"><a href="/blog-other/物联网开发实战/01.2022特别加更/03#智能灯主逻辑实现"><span>智能灯主逻辑实现</span></a></li><li title="设备调试" data-depth="2"><a href="/blog-other/物联网开发实战/01.2022特别加更/03#设备调试"><span>设备调试</span></a></li><li title="小结" data-depth="2"><a href="/blog-other/物联网开发实战/01.2022特别加更/03#小结"><span>小结</span></a></li><li title="思考题" data-depth="2"><a href="/blog-other/物联网开发实战/01.2022特别加更/03#思考题"><span>思考题</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="实战二mqtt开发如何实现联网控制"><a aria-hidden="true" tabindex="-1" href="/blog-other/物联网开发实战/01.2022特别加更/03#实战二mqtt开发如何实现联网控制"><span class="icon icon-link"></span></a>实战二｜MQTT开发：如何实现联网控制？</h1><p>你好，我是郭朝斌。</p><p>在上一节中，我们基于平头哥RVB2601开发板完成了智能电灯硬件的搭建和嵌入式应用的开发，但是打造一款物联网设备，我们还需要将硬件接入物联网平台。接下来，我就来讲解一下RVB2601开发板通过MQTT协议接入阿里云生活物联网平台的流程及方法。</p><p>在开始本节内容的阅读之前，你可以重新打开<a target="_blank" rel="noopener noreferrer" href="https://time.geekbang.org/column/article/322528">第17讲<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，了解一下Python语言的实现代码。对比着本节的C语言代码，你将会对程序开发有更深入的理解。</p><h2 id="生活物联网平台的准备工作"><a aria-hidden="true" tabindex="-1" href="/blog-other/物联网开发实战/01.2022特别加更/03#生活物联网平台的准备工作"><span class="icon icon-link"></span></a>生活物联网平台的准备工作</h2><p>阿里云生活物联网平台，又称为飞燕平台，是面向消费级产品的物联网开放平台。它具备完整的、面向家居物联网场景的功能定义，可以非常方便地完成智能设备的物联网接入工作。</p><p>接下来，我们就在这个平台上完成智能灯的联网控制实验。</p><h3 id="创建项目和产品"><a aria-hidden="true" tabindex="-1" href="/blog-other/物联网开发实战/01.2022特别加更/03#创建项目和产品"><span class="icon icon-link"></span></a>创建项目和产品</h3><p>首先，登录<a target="_blank" rel="noopener noreferrer" href="https://living.aliyun.com/">生活物联网平台<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，我们进行第一个项目的创建。项目的名称，我们可以填写“智能电灯”。对于项目类型，你可以根据产品需求来决定，因为我们不计划接入天猫精灵生态，所以这里选择“自有品牌项目”。</p><p><img src="/blog-other/static/httpsstatic001geekbangorgresourceimagee81ce8c304c43ed2yyd0ac86c8b1ca50ff1c.ae9bfffa.png" alt=""/></p><p>接着，我们为这个“智能电灯”项目创建一个新产品“Led_1”。</p><p><img src="/blog-other/static/httpsstatic001geekbangorgresourceimage15be15fac49fc02321208fc2c7e7f08d13be.df48dae8.png" alt=""/></p><p>产品的参数可以这样设置：</p><ul><li>所属品类，选择“电工照明”–&gt;“灯”。</li><li>节点设备，选择“设备”。是否接入网关，选择“否”。</li><li>连网方式，选择“WiFi”。</li><li>数据格式，选择“ICA标准数据格式（Alink JSON）”。</li></ul><p><img src="/blog-other/static/httpsstatic001geekbangorgresourceimage3b723b07a69c927e1044ac15c4fd9fb02c72.40d32fdc.png" alt=""/><br/><img src="/blog-other/static/httpsstatic001geekbangorgresourceimage254b25275157ebd091863bb2f6f79063a04b.ef74ac43.png" alt=""/></p><h3 id="产品功能定义"><a aria-hidden="true" tabindex="-1" href="/blog-other/物联网开发实战/01.2022特别加更/03#产品功能定义"><span class="icon icon-link"></span></a>产品功能定义</h3><p>创建完产品，我们进入产品的研发流程。物联网平台把流程分为4个阶段，分别是：功能定义、人机交互、设备调试和批量投产。</p><p>首先，我们来完成功能定义的部分，也就是物联网设备的物模型定义。</p><p>基于创建产品时我们选择的产品类型和数据格式，平台已经为智能电灯自动生成了一个标准的物模型。针对你开发的智能灯的功能需求，你可以对各项功能进行编辑、删除，或者新增标准模版没有的功能。比如像我这里展示的一样，保留“开关”、“亮度”和“色温”，删除其他功能项，同时增加“RGB调色”功能。“RGB调色”功能项，对应了我们智能灯的三色LED模块。</p><p><img src="/blog-other/static/httpsstatic001geekbangorgresourceimage9c879cc88d1efafd17b3df580c9beb9b9e87.5f87b687.png" alt=""/></p><h3 id="人机交互设计"><a aria-hidden="true" tabindex="-1" href="/blog-other/物联网开发实战/01.2022特别加更/03#人机交互设计"><span class="icon icon-link"></span></a>人机交互设计</h3><p>完成功能定义后，我们进入下一步，人机交互。在人机交互中，我们主要完成配网方式和手机App相关界面的设计。</p><p>首先，我们选择使用公版App控制产品。这样可以省掉我们开发独立App的工作。</p><p><img src="/blog-other/static/httpsstatic001geekbangorgresourceimage84d1840a382b8cd04459fc6d7b1e5ab57bd1.2689be39.png" alt=""/></p><p>在“产品展示”标签页中，设置一下产品名称。</p><p><img src="/blog-other/static/httpsstatic001geekbangorgresourceimagef225f277da06b5c5d5e7c4210f22cfe50725.d830923b.png" alt=""/></p><p>在“设备面板”中，你可以点击进入“选择面板”页面，选择一个智能灯在App上的展示和操作界面。因为默认面板中没有适配“RGB调色”的面板，所以，你需要编辑一下“灯泡冷暖灯”模版来替代使用。否则，平台会显示错误信息，提示面板与物模型的属性定义不一致。</p><p><img src="/blog-other/static/httpsstatic001geekbangorgresourceimage2767274cd8dd412dd288b03d78568e221467.d6fa8136.png" alt=""/></p><p>配网方式，我们保持默认设置即可。在“自动化与定时”标签页中，我们要勾选“开关”的“作为执行”选项。这样，在自动化场景的创建中，智能电灯的开关就可以作为执行动作起到控制的效果了。</p><h3 id="设备调试设置"><a aria-hidden="true" tabindex="-1" href="/blog-other/物联网开发实战/01.2022特别加更/03#设备调试设置"><span class="icon icon-link"></span></a>设备调试设置</h3><p>在设备调试页面中，我们需要先选择产品使用的芯片或者模组。对于我们的实验项目，这里直接选择列表最后一项——未知芯片即可。</p><p>然后，我们新建一个测试设备。因为我们需要获得一个设备证书，也就是智能灯连接物联网平台的五元组信息。</p><p>点击“新建测试设备”，你需要为测试设备输入一个名称，比如，可以是“RVB2601HoloLed1”。然后，点击“确定”，页面就会新增一个设备条目。</p><p><img src="/blog-other/static/httpsstatic001geekbangorgresourceimage6564652c6d5cd03a189fe9f81ab7d9aa6164.04699519.png" alt=""/></p><p>在新增设备条目中，点击“设备证书”，你就可以看到设备五元组信息。这里要记得复制、保存这些字符串，因为我们在后面的应用代码中需要用到。</p><p><img src="/blog-other/static/httpsstatic001geekbangorgresourceimagef327f31999ae09b207dbfedc5244ceb7c027.f5499238.png" alt=""/></p><p>你可以看到，这个新增测试设备的状态显示“未激活”。因为只有当设备通过MQTT协议第一次连接到物联网平台后，这个测试设备才会被激活，并且可以发送消息进行在线调试。</p><h2 id="智能灯如何接入物联网"><a aria-hidden="true" tabindex="-1" href="/blog-other/物联网开发实战/01.2022特别加更/03#智能灯如何接入物联网"><span class="icon icon-link"></span></a>智能灯如何接入物联网</h2><p>那么，智能灯如何接入物联网平台实现后续的调试、使用呢？下面，我们来开发一下智能灯的联网控制功能。</p><h3 id="联网功能开发"><a aria-hidden="true" tabindex="-1" href="/blog-other/物联网开发实战/01.2022特别加更/03#联网功能开发"><span class="icon icon-link"></span></a>联网功能开发</h3><p>RVB2601开发板中的W800模组提供了Wi-Fi和BLE通信能力，而且模组还集成了连接阿里云生活物联网平台（飞燕）的功能。主控芯片CH2601通过SPI接口与W800模组通信，它只需要发送/接收W800定义的AT指令，就可以实现相应的功能。</p><p>W800模组的AT指令集可以参考<a target="_blank" rel="noopener noreferrer" href="https://occ-oss-prod.oss-cn-hangzhou.aliyuncs.com/userFiles/3717897501090217984/resource/3717897501090217984XBSRZBtccb.pdf">官方文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。我们就基于文档中飞燕平台的相关AT指令来实现与平台的通信。它的底层实现依然是MQTT协议，不过封装成了AT指令的接口形式。</p><p>这里，我们就需要修改W800的驱动代码，增加联网接口函数，其中具体包括：</p><ul><li>设置设备五元组接口</li><li>建立MQTT连接接口</li><li>物模型属性设置回调注册接口</li><li>物模型属性上报接口</li></ul><p>具体要怎么做呢？</p><p>我们需要在项目中引入W800的驱动模块drv_wifi_at_w800。在CDK中，点击右键打开“Packages for Led”，在模块窗口左侧找到drv_wifi_at_w800模块，点击箭头导入右侧列表中。</p><p><img src="/blog-other/static/httpsstatic001geekbangorgresourceimage6f2f6fd57acd5c77daa65d1484fde6a3652f.53ba28aa.png" alt=""/><br/><img src="/blog-other/static/httpsstatic001geekbangorgresourceimageca6fca8410036690753cd7fa27ceaa87c76f.63fcab30.png" alt=""/></p><p>在W800的驱动模块drv_wifi_at_w800中，打开w800_api.h文件，增加函数接口定义。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">int w800_living_idmau(const char *mykey,const char *myname,const char *mysecret,const char *mypsecret);</span></div><div class="token-line"><span class="token plain">    int w800_living_idmcon(void);</span></div><div class="token-line"><span class="token plain">    void w800_living_recv_callback_register(const char *cmd, void *callback, void *context);</span></div><div class="token-line"><span class="token plain">    int w800_living_send_attribute(const char *dev_id, const char *msg);</span></div></pre></div><p>在w800_api.c文件中，增加函数接口的实现代码。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">int w800_living_idmau(const char *mykey,const char *myname,const char *mysecret,const char *mypsecret)</span></div><div class="token-line"><span class="token plain">    {</span></div><div class="token-line"><span class="token plain">    	int ret = -1;</span></div><div class="token-line"><span class="token plain">    	</span></div><div class="token-line"><span class="token plain">    	aos_mutex_lock(&amp;g_cmd_mutex,AOS_WAIT_FOREVER);</span></div><div class="token-line"><span class="token plain">    	</span></div><div class="token-line"><span class="token plain">    	atparser_clr_buf(g_atparser_uservice_t);</span></div><div class="token-line"><span class="token plain">    	</span></div><div class="token-line"><span class="token plain">    	if (atparser_send(g_atparser_uservice_t,</span></div><div class="token-line"><span class="token plain">    		&quot;AT+IDMAU=\&quot;%s\&quot;,\&quot;%s\&quot;,\&quot;%s\&quot;,\&quot;%s\&quot;&quot;, mykey, myname, mysecret, mypsecret) == 0) {</span></div><div class="token-line"><span class="token plain">    		if (atparser_recv(g_atparser_uservice_t, &quot;OK\n&quot;) == 0) {</span></div><div class="token-line"><span class="token plain">    			ret = 0;</span></div><div class="token-line"><span class="token plain">    		}</span></div><div class="token-line"><span class="token plain">    		else {</span></div><div class="token-line"><span class="token plain">    			printf(&quot;Destination Host Unreachable!\r\n&quot;);</span></div><div class="token-line"><span class="token plain">    		}</span></div><div class="token-line"><span class="token plain">    	}</span></div><div class="token-line"><span class="token plain">    	</span></div><div class="token-line"><span class="token plain">    	atparser_cmd_exit(g_atparser_uservice_t);</span></div><div class="token-line"><span class="token plain">    	</span></div><div class="token-line"><span class="token plain">    	if (ret == 0) {</span></div><div class="token-line"><span class="token plain">    		printf(&quot;key = %s name = %s secret = %s psecret = %s!\r\n&quot;, mykey, myname, mysecret, mypsecret);</span></div><div class="token-line"><span class="token plain">    	}</span></div><div class="token-line"><span class="token plain">    	</span></div><div class="token-line"><span class="token plain">    	aos_mutex_unlock(&amp;g_cmd_mutex);</span></div><div class="token-line"><span class="token plain">    	return ret;</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    int w800_living_idmcon(void)</span></div><div class="token-line"><span class="token plain">    {</span></div><div class="token-line"><span class="token plain">    	int ret = -1;</span></div><div class="token-line"><span class="token plain">    	</span></div><div class="token-line"><span class="token plain">    	aos_mutex_lock(&amp;g_cmd_mutex,AOS_WAIT_FOREVER);</span></div><div class="token-line"><span class="token plain">    	</span></div><div class="token-line"><span class="token plain">    	atparser_clr_buf(g_atparser_uservice_t);</span></div><div class="token-line"><span class="token plain">    	</span></div><div class="token-line"><span class="token plain">    	if (atparser_send(g_atparser_uservice_t, &quot;AT+IDMCON&quot;) == 0) {</span></div><div class="token-line"><span class="token plain">    		if (atparser_recv(g_atparser_uservice_t, &quot;OK\n&quot;) == 0) {</span></div><div class="token-line"><span class="token plain">    			ret = 0;</span></div><div class="token-line"><span class="token plain">    		} else {</span></div><div class="token-line"><span class="token plain">    			printf(&quot;Destination Host Unreachable!\r\n&quot;);</span></div><div class="token-line"><span class="token plain">    		}</span></div><div class="token-line"><span class="token plain">    	}</span></div><div class="token-line"><span class="token plain">    	</span></div><div class="token-line"><span class="token plain">    	atparser_cmd_exit(g_atparser_uservice_t);</span></div><div class="token-line"><span class="token plain">    	</span></div><div class="token-line"><span class="token plain">    	if (ret == 0) {</span></div><div class="token-line"><span class="token plain">    		printf(&quot;AT+IDMCON \r\n&quot;);</span></div><div class="token-line"><span class="token plain">    	}</span></div><div class="token-line"><span class="token plain">    	</span></div><div class="token-line"><span class="token plain">    	aos_mutex_unlock(&amp;g_cmd_mutex);</span></div><div class="token-line"><span class="token plain">    	return ret;</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    void w800_living_recv_callback_register(const char *cmd, void *callback, void *context)</span></div><div class="token-line"><span class="token plain">    {</span></div><div class="token-line"><span class="token plain">        atparser_oob_create(g_atparser_uservice_t, cmd, callback, context);</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    int w800_living_send_attribute(const char *dev_id, const char *msg)</span></div><div class="token-line"><span class="token plain">    {</span></div><div class="token-line"><span class="token plain">        int ret = -1;</span></div><div class="token-line"><span class="token plain">        </span></div><div class="token-line"><span class="token plain">        if (!dev_id || !msg) {</span></div><div class="token-line"><span class="token plain">            return ret;</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">    	</span></div><div class="token-line"><span class="token plain">        aos_mutex_lock(&amp;g_cmd_mutex, AOS_WAIT_FOREVER);</span></div><div class="token-line"><span class="token plain">    	</span></div><div class="token-line"><span class="token plain">        atparser_clr_buf(g_atparser_uservice_t);</span></div><div class="token-line"><span class="token plain">    	</span></div><div class="token-line"><span class="token plain">        printf(&quot;Send msg: %s\r\n&quot;, msg);</span></div><div class="token-line"><span class="token plain">        if (atparser_send(g_atparser_uservice_t, &quot;AT+IDMPP=0,\&quot;%s\&quot;&quot;, msg) == 0) {</span></div><div class="token-line"><span class="token plain">            if (atparser_recv(g_atparser_uservice_t, &quot;OK\n&quot;) == 0) {</span></div><div class="token-line"><span class="token plain">                ret = 0;</span></div><div class="token-line"><span class="token plain">                printf(&quot;Send at cmd ok\n&quot;);</span></div><div class="token-line"><span class="token plain">            }</span></div><div class="token-line"><span class="token plain">        } else {</span></div><div class="token-line"><span class="token plain">            printf(&quot;Send at cmd err\n&quot;);</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">    	</span></div><div class="token-line"><span class="token plain">        atparser_cmd_exit(g_atparser_uservice_t);</span></div><div class="token-line"><span class="token plain">    	</span></div><div class="token-line"><span class="token plain">        aos_mutex_unlock(&amp;g_cmd_mutex);</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        return ret;</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>这里，物模型属性设置回调注册接口的实现采用了非侵入的方式，以尽量减少对原代码的修改。所以，这就需要接口调用者，在应用代码中明确地指定AT指令的代码。通常来说，更好的实现方式是通过消息机制来实现，但是这需要定义唯一的、不冲突的消息编号，并且在w800_module_init函数体中增加回调注册代码，侵入性太大，所以并没有选择这样的实现方式。</p><h3 id="智能灯平台交互的封装"><a aria-hidden="true" tabindex="-1" href="/blog-other/物联网开发实战/01.2022特别加更/03#智能灯平台交互的封装"><span class="icon icon-link"></span></a>智能灯平台交互的封装</h3><p>对于智能灯与平台之间的交互逻辑，我们可以新建代码来封装实现。在C语言中，为方便接口函数的调用，我们需要先新建一个头文件—— app_living.h 。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">#ifndef __APP_LIVING_H__</span></div><div class="token-line"><span class="token plain">    #define __APP_LIVING_H__</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    #include &lt;uservice/eventid.h&gt;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    #ifdef __cplusplus</span></div><div class="token-line"><span class="token plain">    extern &quot;C&quot; {</span></div><div class="token-line"><span class="token plain">    #endif</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    #define EVENT_LIVING_ATTR_POWER       (EVENT_USER + 1)</span></div><div class="token-line"><span class="token plain">    #define EVENT_LIVING_ATTR_BRIGHTNESS  (EVENT_USER + 2)</span></div><div class="token-line"><span class="token plain">    #define EVENT_LIVING_ATTR_COLOR       (EVENT_USER + 3)</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    typedef struct RgbColor</span></div><div class="token-line"><span class="token plain">    {</span></div><div class="token-line"><span class="token plain">        unsigned char r;</span></div><div class="token-line"><span class="token plain">        unsigned char g;</span></div><div class="token-line"><span class="token plain">        unsigned char b;</span></div><div class="token-line"><span class="token plain">    } RgbColor;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    void update_attr(uint8_t powerstate, uint8_t bright, RgbColor rgb);</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    int connect_iot_demo(void);</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    #ifdef __cplusplus</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">    #endif</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    #endif /* __APP_LIVING_H__ */</span></div></pre></div><p>然后，新建app_living.c源文件来实现代码逻辑。为了解析从平台发送的JSON格式消息，我们引入了cJSON模块。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">#include &lt;stdlib.h&gt;</span></div><div class="token-line"><span class="token plain">    #include &lt;string.h&gt;</span></div><div class="token-line"><span class="token plain">    #include &lt;aos/debug.h&gt;</span></div><div class="token-line"><span class="token plain">    #include &lt;devices/w800.h&gt;</span></div><div class="token-line"><span class="token plain">    #include &lt;yoc/atparser.h&gt;</span></div><div class="token-line"><span class="token plain">    #include &quot;cJSON.h&quot;</span></div><div class="token-line"><span class="token plain">    #include &quot;app_living.h&quot;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    #define TAG &quot;app_living&quot;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    extern int w800_living_idmau(const char *mykey,const char *myname,const char *mysecret,const char *mypsecretconst);</span></div><div class="token-line"><span class="token plain">    extern int w800_living_idmcon(void);</span></div><div class="token-line"><span class="token plain">    extern void w800_living_recv_callback_register(const char *cmd, void *callback, void *context);</span></div><div class="token-line"><span class="token plain">    extern int w800_living_send_attribute(const char *dev_id, const char *msg);</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    void update_attr(uint8_t powerstate, uint8_t bright, RgbColor rgb)</span></div><div class="token-line"><span class="token plain">    {</span></div><div class="token-line"><span class="token plain">    	printf(&quot;enter update \n&quot;);</span></div><div class="token-line"><span class="token plain">    	const char *dev_id = &quot;0&quot;;</span></div><div class="token-line"><span class="token plain">    	char msg[128] = {0};</span></div><div class="token-line"><span class="token plain">    	const char *msg_format = &quot;{\\\&quot;powerstate\\\&quot;:%d,\\\&quot;brightness\\\&quot;:%d,\\\&quot;RGBColor\\\&quot;:{\\\&quot;Red\\\&quot;:%d,\\\&quot;Green\\\&quot;:%d,\\\&quot;Blue\\\&quot;:%d}}&quot;;</span></div><div class="token-line"><span class="token plain">    	</span></div><div class="token-line"><span class="token plain">    	sprintf(msg, msg_format, powerstate, bright, rgb.r,rgb.g,rgb.b);</span></div><div class="token-line"><span class="token plain">    	</span></div><div class="token-line"><span class="token plain">    	w800_living_send_attribute(dev_id, msg);</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    static int parse_living_msg(const char *msg)</span></div><div class="token-line"><span class="token plain">    {</span></div><div class="token-line"><span class="token plain">        cJSON *root = NULL;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        /* Parse Root */</span></div><div class="token-line"><span class="token plain">        root = cJSON_Parse(msg);</span></div><div class="token-line"><span class="token plain">        if (root == NULL || !cJSON_IsObject(root)) {</span></div><div class="token-line"><span class="token plain">            printf(&quot;JSON Parse Error\n&quot;);</span></div><div class="token-line"><span class="token plain">            return -1;</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">        cJSON *item = cJSON_GetObjectItem(root, &quot;powerstate&quot;);</span></div><div class="token-line"><span class="token plain">    	static uint8_t power_on;</span></div><div class="token-line"><span class="token plain">        if (item &amp;&amp; cJSON_IsNumber(item)) {</span></div><div class="token-line"><span class="token plain">            if (item-&gt;valueint) {</span></div><div class="token-line"><span class="token plain">    			power_on = 1;</span></div><div class="token-line"><span class="token plain">            } else {</span></div><div class="token-line"><span class="token plain">    			power_on = 0;</span></div><div class="token-line"><span class="token plain">            }</span></div><div class="token-line"><span class="token plain">    		event_publish(EVENT_LIVING_ATTR_POWER, &amp;power_on);</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        item = cJSON_GetObjectItem(root, &quot;brightness&quot;);</span></div><div class="token-line"><span class="token plain">    	static uint8_t bright;</span></div><div class="token-line"><span class="token plain">        if (item &amp;&amp; cJSON_IsNumber(item)) {</span></div><div class="token-line"><span class="token plain">    		bright = item-&gt;valueint;</span></div><div class="token-line"><span class="token plain">    		event_publish(EVENT_LIVING_ATTR_BRIGHTNESS, &amp;bright);</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">    	</span></div><div class="token-line"><span class="token plain">    	item = cJSON_GetObjectItem(root, &quot;RGBColor&quot;);</span></div><div class="token-line"><span class="token plain">    	static RgbColor rgb;</span></div><div class="token-line"><span class="token plain">    	if (item &amp;&amp; cJSON_IsObject(item)) {</span></div><div class="token-line"><span class="token plain">    		cJSON *sub_item = cJSON_GetObjectItem(item, &quot;Red&quot;);</span></div><div class="token-line"><span class="token plain">    		if (sub_item &amp;&amp; cJSON_IsNumber(sub_item)) {</span></div><div class="token-line"><span class="token plain">    			rgb.r = sub_item-&gt;valueint;</span></div><div class="token-line"><span class="token plain">    		}</span></div><div class="token-line"><span class="token plain">    		sub_item = cJSON_GetObjectItem(item, &quot;Green&quot;);</span></div><div class="token-line"><span class="token plain">    		if (sub_item &amp;&amp; cJSON_IsNumber(sub_item)) {</span></div><div class="token-line"><span class="token plain">    			rgb.g = sub_item-&gt;valueint;</span></div><div class="token-line"><span class="token plain">    		}</span></div><div class="token-line"><span class="token plain">    		sub_item = cJSON_GetObjectItem(item, &quot;Blue&quot;);</span></div><div class="token-line"><span class="token plain">    		if (sub_item &amp;&amp; cJSON_IsNumber(sub_item)) {</span></div><div class="token-line"><span class="token plain">    			rgb.b = sub_item-&gt;valueint;</span></div><div class="token-line"><span class="token plain">    		}</span></div><div class="token-line"><span class="token plain">    		event_publish(EVENT_LIVING_ATTR_COLOR, &amp;rgb);</span></div><div class="token-line"><span class="token plain">    	}</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        cJSON_Delete(root);</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        return 0;</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    static int living_set_attr_callback(atparser_uservice_t *at, void *priv, oob_data_t *oob_data)</span></div><div class="token-line"><span class="token plain">    {</span></div><div class="token-line"><span class="token plain">    	int did = 0;</span></div><div class="token-line"><span class="token plain">    	int len = 0;</span></div><div class="token-line"><span class="token plain">    	char msg[128] = {0};</span></div><div class="token-line"><span class="token plain">    	char *str = strchr(oob_data-&gt;buf, &#x27;:&#x27;);</span></div><div class="token-line"><span class="token plain">    	if (str != NULL) {</span></div><div class="token-line"><span class="token plain">    		sscanf(oob_data-&gt;buf, &quot;%d,%d,%s\r\n&quot;, &amp;did, &amp;len, msg);</span></div><div class="token-line"><span class="token plain">    		LOGD(TAG,&quot;==&gt;recv data %d(%d):%s\r\n&quot;,did, len, msg);</span></div><div class="token-line"><span class="token plain">    		parse_living_msg(msg);</span></div><div class="token-line"><span class="token plain">    		oob_data-&gt;used_len = len;</span></div><div class="token-line"><span class="token plain">    	}</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        return 0;</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    int connect_iot_demo(void)</span></div><div class="token-line"><span class="token plain">    {</span></div><div class="token-line"><span class="token plain">    	char *my_key = &quot;a1AMULi68xV&quot;;//ProductKey</span></div><div class="token-line"><span class="token plain">    	char *my_name = &quot;RVB2601GeekHoloLed1&quot;;//DeviceName</span></div><div class="token-line"><span class="token plain">    	char *my_secret = &quot;fcdf55e206b907d649e2249aed8c948a&quot;;//DeviceSecret</span></div><div class="token-line"><span class="token plain">    	char *my_p_secret = &quot;BReZtzPVrLcdY1H4&quot;;//Product Secret</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    	int ret2 = -1;</span></div><div class="token-line"><span class="token plain">    	int ret3 = -1;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    	w800_living_recv_callback_register(&quot;+IDMPS:&quot;, living_set_attr_callback, NULL);</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    	ret2 = w800_living_idmau(my_key,my_name,my_secret,my_p_secret);</span></div><div class="token-line"><span class="token plain">    	</span></div><div class="token-line"><span class="token plain">    	if (ret2 == 0){</span></div><div class="token-line"><span class="token plain">    		printf(&quot;AT+IDMAU:OK!\n&quot;);</span></div><div class="token-line"><span class="token plain">    	} else {</span></div><div class="token-line"><span class="token plain">    		printf(&quot;AT+IDMAU:ERROR!\n&quot;);</span></div><div class="token-line"><span class="token plain">    	}</span></div><div class="token-line"><span class="token plain">    	</span></div><div class="token-line"><span class="token plain">    	ret3 = w800_living_idmcon();</span></div><div class="token-line"><span class="token plain">    	if (ret3 == 0){</span></div><div class="token-line"><span class="token plain">    		printf(&quot;AT+IDMCON:OK!\n&quot;);</span></div><div class="token-line"><span class="token plain">    	} else {</span></div><div class="token-line"><span class="token plain">    		printf(&quot;AT+IDMCON:ERROR!\n&quot;);</span></div><div class="token-line"><span class="token plain">    	}</span></div><div class="token-line"><span class="token plain">    	</span></div><div class="token-line"><span class="token plain">    	if(ret2 == 0 &amp;&amp; ret3 == 0){</span></div><div class="token-line"><span class="token plain">    		return 0;</span></div><div class="token-line"><span class="token plain">    	}else{</span></div><div class="token-line"><span class="token plain">    		return -1;</span></div><div class="token-line"><span class="token plain">    	}</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><blockquote><p>注意替换上面代码中connect_iot_demo函数使用的设备五元组信息。</p></blockquote><h3 id="led颜色控制实现"><a aria-hidden="true" tabindex="-1" href="/blog-other/物联网开发实战/01.2022特别加更/03#led颜色控制实现"><span class="icon icon-link"></span></a>LED颜色控制实现</h3><p>为了控制亮度，我们也需要对上一节中的LED控制代码进行改造，具体代码如下。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">/*********************</span></div><div class="token-line"><span class="token plain">     *      INCLUDES</span></div><div class="token-line"><span class="token plain">     *********************/</span></div><div class="token-line"><span class="token plain">    #define _DEFAULT_SOURCE /* needed for usleep() */</span></div><div class="token-line"><span class="token plain">    #include &lt;stdio.h&gt;</span></div><div class="token-line"><span class="token plain">    #include &lt;stdlib.h&gt;</span></div><div class="token-line"><span class="token plain">    #include &lt;unistd.h&gt;</span></div><div class="token-line"><span class="token plain">    #include &lt;time.h&gt;</span></div><div class="token-line"><span class="token plain">    #include &lt;aos/aos.h&gt;</span></div><div class="token-line"><span class="token plain">    #include &quot;app_config.h&quot;</span></div><div class="token-line"><span class="token plain">    #include &quot;app_main.h&quot;</span></div><div class="token-line"><span class="token plain">    #include &quot;csi_config.h&quot;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    #include &quot;board_config.h&quot;</span></div><div class="token-line"><span class="token plain">    #include &quot;drv/gpio_pin.h&quot;</span></div><div class="token-line"><span class="token plain">    #include &lt;drv/pin.h&gt;</span></div><div class="token-line"><span class="token plain">    #include &lt;drv/pwm.h&gt;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    #ifdef CONFIG_PWM_MODE</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    static csi_pwm_t  r;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    void led_pinmux_init()</span></div><div class="token-line"><span class="token plain">    {</span></div><div class="token-line"><span class="token plain">            //7</span></div><div class="token-line"><span class="token plain">        csi_error_t ret;</span></div><div class="token-line"><span class="token plain">        csi_pin_set_mux(PA7, PA7_PWM_CH7);</span></div><div class="token-line"><span class="token plain">        csi_pin_set_mux(PA25, PA25_PWM_CH2);</span></div><div class="token-line"><span class="token plain">        csi_pin_set_mux(PA4, PA4_PWM_CH4);</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        ret = csi_pwm_init(&amp;r, 0);</span></div><div class="token-line"><span class="token plain">        if (ret != CSI_OK) {</span></div><div class="token-line"><span class="token plain">                printf(&quot;===%s, %d\n&quot;, __FUNCTION__, __LINE__);</span></div><div class="token-line"><span class="token plain">                return ;</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    void rgb_light(uint32_t red, uint32_t green, uint32_t blue, uint8_t brightness)</span></div><div class="token-line"><span class="token plain">    {</span></div><div class="token-line"><span class="token plain">    	csi_error_t ret;</span></div><div class="token-line"><span class="token plain">    	ret = csi_pwm_out_config(&amp;r, 7 / 2, 300, red*300*brightness/100/255, PWM_POLARITY_HIGH);</span></div><div class="token-line"><span class="token plain">        if (ret != CSI_OK) {</span></div><div class="token-line"><span class="token plain">                printf(&quot;===%s, %d\n&quot;, __FUNCTION__, __LINE__);</span></div><div class="token-line"><span class="token plain">                return ;</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">        ret = csi_pwm_out_start(&amp;r, 7 / 2);</span></div><div class="token-line"><span class="token plain">        if (ret != CSI_OK) {</span></div><div class="token-line"><span class="token plain">                printf(&quot;===%s, %d\n&quot;, __FUNCTION__, __LINE__);</span></div><div class="token-line"><span class="token plain">                return ;</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">            //25</span></div><div class="token-line"><span class="token plain">        ret = csi_pwm_out_config(&amp;r, 2 / 2, 300, green*300*brightness/100/255, PWM_POLARITY_HIGH);</span></div><div class="token-line"><span class="token plain">        if (ret != CSI_OK) {</span></div><div class="token-line"><span class="token plain">                printf(&quot;===%s, %d\n&quot;, __FUNCTION__, __LINE__);</span></div><div class="token-line"><span class="token plain">                return ;</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">        ret = csi_pwm_out_start(&amp;r, 2 / 2);</span></div><div class="token-line"><span class="token plain">        if (ret != CSI_OK) {</span></div><div class="token-line"><span class="token plain">                printf(&quot;===%s, %d\n&quot;, __FUNCTION__, __LINE__);</span></div><div class="token-line"><span class="token plain">                return ;</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">            //4</span></div><div class="token-line"><span class="token plain">        ret = csi_pwm_out_config(&amp;r, 4 / 2, 300, blue*300*brightness/100/255, PWM_POLARITY_HIGH);</span></div><div class="token-line"><span class="token plain">        if (ret != CSI_OK) {</span></div><div class="token-line"><span class="token plain">                printf(&quot;===%s, %d\n&quot;, __FUNCTION__, __LINE__);</span></div><div class="token-line"><span class="token plain">                return ;</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">        ret = csi_pwm_out_start(&amp;r, 4 / 2);</span></div><div class="token-line"><span class="token plain">        if (ret != CSI_OK) {</span></div><div class="token-line"><span class="token plain">                printf(&quot;===%s, %d\n&quot;, __FUNCTION__, __LINE__);</span></div><div class="token-line"><span class="token plain">                return ;</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">    #endif </span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    #ifdef CONFIG_GPIO_MODE</span></div><div class="token-line"><span class="token plain">    static uint32_t g_ctr = 0;</span></div><div class="token-line"><span class="token plain">    static csi_gpio_pin_t r;</span></div><div class="token-line"><span class="token plain">    static csi_gpio_pin_t g;</span></div><div class="token-line"><span class="token plain">    static csi_gpio_pin_t b;</span></div><div class="token-line"><span class="token plain">    void led_pinmux_init()</span></div><div class="token-line"><span class="token plain">    {</span></div><div class="token-line"><span class="token plain">        csi_pin_set_mux(PA7, PIN_FUNC_GPIO);</span></div><div class="token-line"><span class="token plain">        csi_pin_set_mux(PA25, PIN_FUNC_GPIO);</span></div><div class="token-line"><span class="token plain">        csi_pin_set_mux(PA4, PIN_FUNC_GPIO);</span></div><div class="token-line"><span class="token plain">        csi_gpio_pin_init(&amp;r, PA7);</span></div><div class="token-line"><span class="token plain">        csi_gpio_pin_dir(&amp;r, GPIO_DIRECTION_OUTPUT);</span></div><div class="token-line"><span class="token plain">    	csi_gpio_pin_mode(&amp;r, GPIO_MODE_PUSH_PULL);</span></div><div class="token-line"><span class="token plain">        csi_gpio_pin_init(&amp;g, PA25);</span></div><div class="token-line"><span class="token plain">        csi_gpio_pin_dir(&amp;g, GPIO_DIRECTION_OUTPUT);</span></div><div class="token-line"><span class="token plain">    	csi_gpio_pin_mode(&amp;g, GPIO_MODE_PUSH_PULL);</span></div><div class="token-line"><span class="token plain">        csi_gpio_pin_init(&amp;b, PA4);</span></div><div class="token-line"><span class="token plain">        csi_gpio_pin_dir(&amp;b, GPIO_DIRECTION_OUTPUT);</span></div><div class="token-line"><span class="token plain">    	csi_gpio_pin_mode(&amp;b, GPIO_MODE_PUSH_PULL);</span></div><div class="token-line"><span class="token plain">        g_ctr = 0;</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    //fake rgb, because of only high or low state of gpio</span></div><div class="token-line"><span class="token plain">    void rgb_light(uint32_t red, uint32_t green, uint32_t blue)</span></div><div class="token-line"><span class="token plain">    {</span></div><div class="token-line"><span class="token plain">    	(red &lt; 50)?csi_gpio_pin_write(&amp;r, GPIO_PIN_LOW):csi_gpio_pin_write(&amp;r, GPIO_PIN_HIGH);</span></div><div class="token-line"><span class="token plain">    	(green &lt; 50)?csi_gpio_pin_write(&amp;r, GPIO_PIN_LOW):csi_gpio_pin_write(&amp;g, GPIO_PIN_HIGH);</span></div><div class="token-line"><span class="token plain">    	(blue &lt; 50)?csi_gpio_pin_write(&amp;r, GPIO_PIN_LOW):csi_gpio_pin_write(&amp;b, GPIO_PIN_HIGH);</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">    #endif</span></div></pre></div><h3 id="继电器状态获取实现"><a aria-hidden="true" tabindex="-1" href="/blog-other/物联网开发实战/01.2022特别加更/03#继电器状态获取实现"><span class="icon icon-link"></span></a>继电器状态获取实现</h3><p>为了获取继电器状态，也就是LED灯的开关状态，我们同样需要对继电器代码进行改造。具体代码如下。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">/*********************</span></div><div class="token-line"><span class="token plain">     *      INCLUDES</span></div><div class="token-line"><span class="token plain">     *********************/</span></div><div class="token-line"><span class="token plain">    #define _DEFAULT_SOURCE /* needed for usleep() */</span></div><div class="token-line"><span class="token plain">    #include &lt;stdio.h&gt;</span></div><div class="token-line"><span class="token plain">    #include &lt;stdlib.h&gt;</span></div><div class="token-line"><span class="token plain">    #include &lt;unistd.h&gt;</span></div><div class="token-line"><span class="token plain">    #include &lt;time.h&gt;</span></div><div class="token-line"><span class="token plain">    #include &lt;aos/aos.h&gt;</span></div><div class="token-line"><span class="token plain">    #include &quot;app_config.h&quot;</span></div><div class="token-line"><span class="token plain">    #include &quot;csi_config.h&quot;</span></div><div class="token-line"><span class="token plain">    #include &quot;app_main.h&quot;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    #include &quot;board_config.h&quot;</span></div><div class="token-line"><span class="token plain">    #include &quot;drv/gpio_pin.h&quot;</span></div><div class="token-line"><span class="token plain">    #include &lt;drv/pin.h&gt;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    static csi_gpio_pin_t relay;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    unsigned char get_state()</span></div><div class="token-line"><span class="token plain">    {</span></div><div class="token-line"><span class="token plain">    	return csi_gpio_pin_read(&amp;relay);</span></div><div class="token-line"><span class="token plain">    } </span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    void relay_pinmux_init() </span></div><div class="token-line"><span class="token plain">    {</span></div><div class="token-line"><span class="token plain">    	csi_pin_set_mux(PA26, PIN_FUNC_GPIO);</span></div><div class="token-line"><span class="token plain">    	csi_gpio_pin_init(&amp;relay, PA26);</span></div><div class="token-line"><span class="token plain">        csi_gpio_pin_dir(&amp;relay, GPIO_DIRECTION_OUTPUT);</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    void relay_toggle(bool on)</span></div><div class="token-line"><span class="token plain">    {</span></div><div class="token-line"><span class="token plain">    	if(on)</span></div><div class="token-line"><span class="token plain">    	{</span></div><div class="token-line"><span class="token plain">    		csi_gpio_pin_write(&amp;relay, GPIO_PIN_HIGH);</span></div><div class="token-line"><span class="token plain">    	} </span></div><div class="token-line"><span class="token plain">    	else </span></div><div class="token-line"><span class="token plain">    	{</span></div><div class="token-line"><span class="token plain">    		csi_gpio_pin_write(&amp;relay, GPIO_PIN_LOW);</span></div><div class="token-line"><span class="token plain">    	}</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><h3 id="网络初始化实现"><a aria-hidden="true" tabindex="-1" href="/blog-other/物联网开发实战/01.2022特别加更/03#网络初始化实现"><span class="icon icon-link"></span></a>网络初始化实现</h3><p>在编写应用的主逻辑之前，我们需要先对RVB2601开发板进行初始化。其中，网络初始化是我们为实现联网新增的代码逻辑。</p><p>网络初始化分为两步。第一步是初始化W800模块：在设置好GPIO口、波特率和缓冲大小后，通过调用wifi_w800_register函数初始化；第二步是配置网络管理器（netmgr）模块：这里你需要将netmgr_config_wifi函数中的入参替换成自己的Wi-Fi网络SSID和密码，并且注意修改入参中的数字为SSID字符串和密码字符串的长度。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">#include &lt;stdbool.h&gt;</span></div><div class="token-line"><span class="token plain">    #include &lt;aos/kv.h&gt;</span></div><div class="token-line"><span class="token plain">    #include &lt;yoc/partition.h&gt;</span></div><div class="token-line"><span class="token plain">    #include &lt;yoc/init.h&gt;</span></div><div class="token-line"><span class="token plain">    #include &lt;drv/pin.h&gt;</span></div><div class="token-line"><span class="token plain">    #include &lt;yoc/at_port.h&gt;</span></div><div class="token-line"><span class="token plain">    #include &lt;devices/w800.h&gt;</span></div><div class="token-line"><span class="token plain">    #include &lt;devices/drv_snd_alkaid.h&gt;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    #include &quot;app_main.h&quot;</span></div><div class="token-line"><span class="token plain">    #include &quot;board.h&quot;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    #define TAG &quot;init&quot;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    netmgr_hdl_t app_netmgr_hdl;</span></div><div class="token-line"><span class="token plain">    extern at_channel_t spi_channel;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    static void network_init()</span></div><div class="token-line"><span class="token plain">    {</span></div><div class="token-line"><span class="token plain">        w800_wifi_param_t w800_param;</span></div><div class="token-line"><span class="token plain">        /* init wifi driver and network */</span></div><div class="token-line"><span class="token plain">        w800_param.reset_pin      = PA21;</span></div><div class="token-line"><span class="token plain">        w800_param.baud           = 1*1000000;</span></div><div class="token-line"><span class="token plain">        w800_param.cs_pin         = PA15;</span></div><div class="token-line"><span class="token plain">        w800_param.wakeup_pin     = PA25;</span></div><div class="token-line"><span class="token plain">        w800_param.int_pin        = PA22;</span></div><div class="token-line"><span class="token plain">        w800_param.channel_id     = 0;</span></div><div class="token-line"><span class="token plain">        w800_param.buffer_size    = 4*1024;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        wifi_w800_register(NULL, &amp;w800_param);</span></div><div class="token-line"><span class="token plain">        app_netmgr_hdl = netmgr_dev_wifi_init();</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        if (app_netmgr_hdl) {</span></div><div class="token-line"><span class="token plain">            utask_t *task = utask_new(&quot;netmgr&quot;, 2 * 1024, QUEUE_MSG_COUNT, AOS_DEFAULT_APP_PRI);</span></div><div class="token-line"><span class="token plain">            netmgr_service_init(task);</span></div><div class="token-line"><span class="token plain">            netmgr_config_wifi(app_netmgr_hdl, &quot;你的wifi SSID&quot;, 11, &quot;你的wifi AP密码&quot;, 11);</span></div><div class="token-line"><span class="token plain">            netmgr_start(app_netmgr_hdl);</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    void board_yoc_init(void)</span></div><div class="token-line"><span class="token plain">    {</span></div><div class="token-line"><span class="token plain">        board_init();</span></div><div class="token-line"><span class="token plain">        event_service_init(NULL);</span></div><div class="token-line"><span class="token plain">        console_init(CONSOLE_UART_IDX, 115200, 512);</span></div><div class="token-line"><span class="token plain">        ulog_init();</span></div><div class="token-line"><span class="token plain">        aos_set_log_level(AOS_LL_DEBUG);</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        int ret = partition_init();</span></div><div class="token-line"><span class="token plain">        if (ret &lt;= 0) {</span></div><div class="token-line"><span class="token plain">            LOGE(TAG, &quot;partition init failed&quot;);</span></div><div class="token-line"><span class="token plain">        } else {</span></div><div class="token-line"><span class="token plain">            LOGI(TAG, &quot;find %d partitions&quot;, ret);</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        aos_kv_init(&quot;kv&quot;);</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        network_init();</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        board_cli_init();</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><h3 id="智能灯主逻辑实现"><a aria-hidden="true" tabindex="-1" href="/blog-other/物联网开发实战/01.2022特别加更/03#智能灯主逻辑实现"><span class="icon icon-link"></span></a>智能灯主逻辑实现</h3><p>在完成了W800驱动程序的增补、平台交互功能的封装以及LED模块、继电器代码的改造等一系列准备之后，我们就可以编写智能灯的主逻辑了。智能灯的主逻辑在app_main.c文件中实现。</p><p>主逻辑包含几个模块：首先是初始化开发板、LED灯和继电器模块；然后是注册网络管理器事件的回调函数，和注册我们在平台交互模块中定义的属性设置事件的回调函数；最后，就是在while循环中建立物联网平台连接，并定期上报智能灯状态。</p><p>我们看一下具体的代码：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">#include &lt;stdlib.h&gt;</span></div><div class="token-line"><span class="token plain">    #include &lt;string.h&gt;</span></div><div class="token-line"><span class="token plain">    #include &lt;aos/list.h&gt;</span></div><div class="token-line"><span class="token plain">    #include &lt;aos/debug.h&gt;</span></div><div class="token-line"><span class="token plain">    #include &lt;uservice/uservice.h&gt;</span></div><div class="token-line"><span class="token plain">    #include &lt;uservice/eventid.h&gt;</span></div><div class="token-line"><span class="token plain">    #include &lt;yoc/sysinfo.h&gt;</span></div><div class="token-line"><span class="token plain">    #include &lt;board.h&gt;</span></div><div class="token-line"><span class="token plain">    #include &quot;drv/gpio_pin.h&quot;</span></div><div class="token-line"><span class="token plain">    #include &lt;drv/pin.h&gt;</span></div><div class="token-line"><span class="token plain">    #include &lt;drv/pwm.h&gt;</span></div><div class="token-line"><span class="token plain">    #include &quot;app_living.h&quot;</span></div><div class="token-line"><span class="token plain">    #include &quot;app_main.h&quot;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    #define TAG &quot;APP&quot;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    static bool g_wifi_ok;</span></div><div class="token-line"><span class="token plain">    static uint8_t led_brightness;</span></div><div class="token-line"><span class="token plain">    static RgbColor led_color;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    static void led_control(uint8_t power) {</span></div><div class="token-line"><span class="token plain">    	relay_toggle(power);</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    static void led_set_brightness(uint8_t bright) {</span></div><div class="token-line"><span class="token plain">    	led_brightness = bright;</span></div><div class="token-line"><span class="token plain">    	rgb_light(led_color.r, led_color.g, led_color.b, bright);</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    static void led_set_color(RgbColor color) {</span></div><div class="token-line"><span class="token plain">    	led_color.r = color.r;</span></div><div class="token-line"><span class="token plain">    	led_color.g = color.g;</span></div><div class="token-line"><span class="token plain">    	led_color.b = color.b;</span></div><div class="token-line"><span class="token plain">    	rgb_light(color.r, color.g, color.b, led_brightness);</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    static void living_event(uint32_t event_id, const void *param, void *context)</span></div><div class="token-line"><span class="token plain">    {</span></div><div class="token-line"><span class="token plain">    	switch(event_id) {</span></div><div class="token-line"><span class="token plain">        case EVENT_LIVING_ATTR_POWER:</span></div><div class="token-line"><span class="token plain">            printf(&quot;set attr power:%d\n&quot;, *(uint8_t *)param);</span></div><div class="token-line"><span class="token plain">    		led_control(*(uint8_t *)param);</span></div><div class="token-line"><span class="token plain">            break;</span></div><div class="token-line"><span class="token plain">        case EVENT_LIVING_ATTR_BRIGHTNESS:</span></div><div class="token-line"><span class="token plain">            printf(&quot;set attr bright:%d\n&quot;, *(uint8_t *)param);</span></div><div class="token-line"><span class="token plain">    		led_set_brightness(*(uint8_t *)param);</span></div><div class="token-line"><span class="token plain">            break;</span></div><div class="token-line"><span class="token plain">    	case EVENT_LIVING_ATTR_COLOR:</span></div><div class="token-line"><span class="token plain">    		printf(&quot;set attr color\n&quot;);</span></div><div class="token-line"><span class="token plain">    		led_set_color(*(RgbColor *)param);</span></div><div class="token-line"><span class="token plain">    		break;</span></div><div class="token-line"><span class="token plain">       }</span></div><div class="token-line"><span class="token plain">        /*do exception process */</span></div><div class="token-line"><span class="token plain">        app_exception_event(event_id);</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    static void network_event(uint32_t event_id, const void *param, void *context)</span></div><div class="token-line"><span class="token plain">    {</span></div><div class="token-line"><span class="token plain">        switch(event_id) {</span></div><div class="token-line"><span class="token plain">        case EVENT_NETMGR_GOT_IP:</span></div><div class="token-line"><span class="token plain">            LOGD(TAG, &quot;net got ip&quot;);</span></div><div class="token-line"><span class="token plain">    		g_wifi_ok = true;</span></div><div class="token-line"><span class="token plain">            break;</span></div><div class="token-line"><span class="token plain">        case EVENT_NETMGR_NET_DISCON:</span></div><div class="token-line"><span class="token plain">            LOGD(TAG, &quot;net disconnect&quot;);</span></div><div class="token-line"><span class="token plain">            break;</span></div><div class="token-line"><span class="token plain">       }</span></div><div class="token-line"><span class="token plain">        /*do exception process */</span></div><div class="token-line"><span class="token plain">        app_exception_event(event_id);</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    int main(void)</span></div><div class="token-line"><span class="token plain">    {</span></div><div class="token-line"><span class="token plain">    	uint32_t time_cnt = 0;</span></div><div class="token-line"><span class="token plain">    	bool mqtt_conn = false;</span></div><div class="token-line"><span class="token plain">        board_yoc_init();</span></div><div class="token-line"><span class="token plain">    	</span></div><div class="token-line"><span class="token plain">    	led_pinmux_init();</span></div><div class="token-line"><span class="token plain">    	relay_pinmux_init();</span></div><div class="token-line"><span class="token plain">    	</span></div><div class="token-line"><span class="token plain">    	led_color.r = 255;</span></div><div class="token-line"><span class="token plain">    	led_color.g = 255;</span></div><div class="token-line"><span class="token plain">    	led_color.b = 0;</span></div><div class="token-line"><span class="token plain">    	led_brightness = 100;</span></div><div class="token-line"><span class="token plain">    	rgb_light(led_color.r, led_color.g, led_color.b, led_brightness);</span></div><div class="token-line"><span class="token plain">    	relay_toggle(true);</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        /* Subscribe */</span></div><div class="token-line"><span class="token plain">        event_subscribe(EVENT_NETMGR_GOT_IP, network_event, NULL);</span></div><div class="token-line"><span class="token plain">        event_subscribe(EVENT_NETMGR_NET_DISCON, network_event, NULL);</span></div><div class="token-line"><span class="token plain">    	event_subscribe(EVENT_LIVING_ATTR_POWER, living_event, NULL);</span></div><div class="token-line"><span class="token plain">    	event_subscribe(EVENT_LIVING_ATTR_BRIGHTNESS, living_event, NULL);</span></div><div class="token-line"><span class="token plain">    	event_subscribe(EVENT_LIVING_ATTR_COLOR, living_event, NULL);</span></div><div class="token-line"><span class="token plain">    	</span></div><div class="token-line"><span class="token plain">    	while(1){</span></div><div class="token-line"><span class="token plain">    		if (g_wifi_ok) {</span></div><div class="token-line"><span class="token plain">    			int ret = connect_iot_demo();</span></div><div class="token-line"><span class="token plain">    			if (ret == 0){</span></div><div class="token-line"><span class="token plain">    				printf(&quot;connerct iot success&quot;);</span></div><div class="token-line"><span class="token plain">    				mqtt_conn = true;</span></div><div class="token-line"><span class="token plain">    			}else{</span></div><div class="token-line"><span class="token plain">    				printf(&quot;connerct iot error&quot;);</span></div><div class="token-line"><span class="token plain">    			}</span></div><div class="token-line"><span class="token plain">    			g_wifi_ok = false;</span></div><div class="token-line"><span class="token plain">    		}</span></div><div class="token-line"><span class="token plain">    		</span></div><div class="token-line"><span class="token plain">    		if (mqtt_conn &amp;&amp; time_cnt &gt;= 10) {</span></div><div class="token-line"><span class="token plain">    			update_attr(get_state(), led_brightness, led_color);</span></div><div class="token-line"><span class="token plain">    			time_cnt = 0;</span></div><div class="token-line"><span class="token plain">    		}</span></div><div class="token-line"><span class="token plain">    		</span></div><div class="token-line"><span class="token plain">    		time_cnt += 1;</span></div><div class="token-line"><span class="token plain">    		aos_msleep(500);</span></div><div class="token-line"><span class="token plain">    	}</span></div><div class="token-line"><span class="token plain">     </span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>最后，主逻辑app_main.c的头文件内容如下，供你参考。其中包含了硬件初始化接口函数，和LED模块、继电器功能接口函数的声明，以便源代码引用。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">/*</span></div><div class="token-line"><span class="token plain">     * Copyright (C) 2019-2020 Alibaba Group Holding Limited</span></div><div class="token-line"><span class="token plain">     */</span></div><div class="token-line"><span class="token plain">    #ifndef _APP_MAIN_H_</span></div><div class="token-line"><span class="token plain">    #define _APP_MAIN_H_</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    #include &lt;uservice/uservice.h&gt;</span></div><div class="token-line"><span class="token plain">    #include &lt;yoc/netmgr_service.h&gt;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    void board_cli_init();</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    #include &lt;stdint.h&gt;</span></div><div class="token-line"><span class="token plain">    extern netmgr_hdl_t app_netmgr_hdl;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    void app_exception_event(uint32_t event_id);</span></div><div class="token-line"><span class="token plain">    void board_yoc_init(void);</span></div><div class="token-line"><span class="token plain">    void led_pinmux_init();</span></div><div class="token-line"><span class="token plain">    void rgb_light(uint32_t red, uint32_t green, uint32_t blue, uint8_t brightness);</span></div><div class="token-line"><span class="token plain">    void relay_pinmux_init();</span></div><div class="token-line"><span class="token plain">    void relay_toggle(bool on);</span></div><div class="token-line"><span class="token plain">    unsigned char get_state();</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    #endif</span></div></pre></div><h2 id="设备调试"><a aria-hidden="true" tabindex="-1" href="/blog-other/物联网开发实战/01.2022特别加更/03#设备调试"><span class="icon icon-link"></span></a>设备调试</h2><p>在完成代码编写后，我们依然按照上一节中步骤，编译——烧录——运行，让智能灯开始工作，并接入物联网平台。</p><p>这时，我们就可以对智能灯进行在线调试了。打开阿里云生活物联网平台的设备调试页面后，我们点击测试设备条目中的“调试”操作，就会进入在线调试页面。</p><p>在调试页面中，我们可以选择调试功能“开关”，方法选择“设置”。下面的消息框中会自动根据物模型准备好JSON格式的消息体。</p><p><img src="/blog-other/static/httpsstatic001geekbangorgresourceimagedf7ddf6yy6b7f1d09657cda991e58d1b507d.d354253f.png" alt=""/></p><p>点击“发送指令”后，这个属性设置消息就会发送到智能灯，实现对智能灯的控制。当然，你也可以选择其他的属性进行设备测试。</p><p>另外，我们还可以在公版云智能App中测试、使用已接入平台的智能灯。这里要怎么实现公版云智能App的控制呢？你需要进入“批量投产”页面，然后点击“配网+App下载二维码”，根据提示下载云智能App到手机。接着，点击“产品发布”完成产品上线。</p><p><img src="/blog-other/static/httpsstatic001geekbangorgresourceimage3949395747e61c1ebf089810764b9b2bdd49.b3a923db.png" alt=""/></p><p>完成这些准备工作后，你就可以在云智能App中添加我们的测试设备了。这里需要注意的是，要保证App和智能灯设备都连接到同一个Wi-Fi网络中，否则，云智能App是不能发现智能灯设备的。</p><p>App上的具体展示内容如下：</p><p><img src="/blog-other/static/httpsstatic001geekbangorgresourceimage060d063f63945f3174f047815bde4c22490d.228d9ea4.jpg" alt=""/></p><h2 id="小结"><a aria-hidden="true" tabindex="-1" href="/blog-other/物联网开发实战/01.2022特别加更/03#小结"><span class="icon icon-link"></span></a>小结</h2><p>到这里，我们就完成了智能灯的联网控制开发任务。</p><p>在实验中，我们使用的物联网平台是阿里云生活物联网平台，整体的创建流程与第17讲的平台类似。重点是物模型的定义和人机交互界面的设计。</p><p>在智能灯的联网控制开发中，我们使用W800模组提供的AT指令来实现平台的交互。AT指令是通信领域常用的控制协议，在嵌入式领域也有广泛的应用，你可以基于本实验对它进行扩展学习。在连接Wi-Fi网络时，我们会使用到YoC嵌入式系统平台提供的网络管理器模块。关于YoC是什么，和模块的关系又是什么，我会在下一节详细讲解。</p><h2 id="思考题"><a aria-hidden="true" tabindex="-1" href="/blog-other/物联网开发实战/01.2022特别加更/03#思考题"><span class="icon icon-link"></span></a>思考题</h2><p>最后，我给你留一个思考题。你可能注意到源代码中有些函数的前面有static关键字，有些函数前面没有这个关键字。比如函数parse_living_msg前面有static，这是为什么呢？欢迎你在评论区写一下自己的理解，也欢迎你将这一节分享给你的朋友，大家一起交流学习。</p></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/GGwujun/blog/edit/master/ssrc/物联网开发实战/01.2022特别加更/03.md">在 GitHub 上编辑此页<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="最后更新时间：">2023/9/23 21:58:31</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script>
      (function () {
        if (!location.port) {
          (function (i, s, o, g, r, a, m) {
            i["GoogleAnalyticsObject"] = r;
            (i[r] =
              i[r] ||
              function () {
                (i[r].q = i[r].q || []).push(arguments);
              }),
              (i[r].l = 1 * new Date());
            (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m);
          })(
            window,
            document,
            "script",
            "//www.google-analytics.com/analytics.js",
            "ga"
          );
          ga("create", "UA-149864185-1", "auto");
          ga("send", "pageview");
        }
      })();
    </script>
    <script src="/blog-other/umi.js"></script>
  </body>
</html>
