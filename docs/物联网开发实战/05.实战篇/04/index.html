<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="/logo.png" />
    <link rel="stylesheet" href="/blog-other/umi.css" />
    <script>
      window.routerBase = "/blog-other";
    </script>
    <script>
      //! umi version: 3.5.41
    </script>
    <script>
      !(function () {
        var e =
            navigator.cookieEnabled && void 0 !== window.localStorage
              ? localStorage.getItem("dumi:prefers-color")
              : "auto",
          o = window.matchMedia("(prefers-color-scheme: dark)").matches,
          t = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === t[2] ? (o ? t[1] : t[0]) : t.indexOf(e) > -1 ? e : t[0]
        );
      })();
    </script>
    <title>19 | 场景联动：智能电灯如何感知光线？（下） - 大师兄</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/物联网开发实战/05.实战篇/04" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-other/">大师兄</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span>前端开发<ul><li><a href="/blog-other/说透低代码">说透低代码</a></li><li><a href="/blog-other/反爬虫兵法演绎20讲">反爬虫兵法演绎20讲</a></li></ul></span><span>产品与用户体验<ul><li><a href="/blog-other/大厂广告产品心法">大厂广告产品心法</a></li></ul></span><span>面试<ul><li><a href="/blog-other/技术面试官识人手册">技术面试官识人手册</a></li><li><a href="/blog-other/面试现场">面试现场</a></li></ul></span><span>杂谈<ul><li><a href="/blog-other/乔新亮的cto成长复盘">乔新亮的cto成长复盘</a></li><li><a href="/blog-other/互联网人的英语私教课">互联网人的英语私教课</a></li><li><a href="/blog-other/从0开始学游戏开发">从0开始学游戏开发</a></li><li><a href="/blog-other/全栈工程师修炼指南">全栈工程师修炼指南</a></li><li><a href="/blog-other/手机摄影">手机摄影</a></li><li><a aria-current="page" class="active" href="/blog-other/物联网开发实战">物联网开发实战</a></li><li><a href="/blog-other/白话法律42讲">白话法律42讲</a></li><li><a href="/blog-other/说透5g">说透5g</a></li><li><a href="/blog-other/超级访谈对话张雪峰">超级访谈对话张雪峰</a></li><li><a href="/blog-other/零基础实战机器学习">零基础实战机器学习</a></li></ul></span><div class="__dumi-default-navbar-tool"><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-other/"></a><h1>大师兄</h1><p></p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li>前端开发<ul><li><a href="/blog-other/说透低代码">说透低代码</a></li><li><a href="/blog-other/反爬虫兵法演绎20讲">反爬虫兵法演绎20讲</a></li></ul></li><li>产品与用户体验<ul><li><a href="/blog-other/大厂广告产品心法">大厂广告产品心法</a></li></ul></li><li>面试<ul><li><a href="/blog-other/技术面试官识人手册">技术面试官识人手册</a></li><li><a href="/blog-other/面试现场">面试现场</a></li></ul></li><li>杂谈<ul><li><a href="/blog-other/乔新亮的cto成长复盘">乔新亮的cto成长复盘</a></li><li><a href="/blog-other/互联网人的英语私教课">互联网人的英语私教课</a></li><li><a href="/blog-other/从0开始学游戏开发">从0开始学游戏开发</a></li><li><a href="/blog-other/全栈工程师修炼指南">全栈工程师修炼指南</a></li><li><a href="/blog-other/手机摄影">手机摄影</a></li><li><a aria-current="page" class="active" href="/blog-other/物联网开发实战">物联网开发实战</a></li><li><a href="/blog-other/白话法律42讲">白话法律42讲</a></li><li><a href="/blog-other/说透5g">说透5g</a></li><li><a href="/blog-other/超级访谈对话张雪峰">超级访谈对话张雪峰</a></li><li><a href="/blog-other/零基础实战机器学习">零基础实战机器学习</a></li></ul></li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a href="/blog-other/物联网开发实战">物联网开发实战</a></li><li><a href="/blog-other/物联网开发实战/01.2022特别加更">01.2022特别加更</a><ul><li><a href="/blog-other/物联网开发实战/01.2022特别加更/01"><span>引子｜RISC-V：物联网领域值得关注的芯片趋势是什么？</span></a></li><li><a href="/blog-other/物联网开发实战/01.2022特别加更/02"><span>实战一｜嵌入式开发：如何使用C语言开发智能电灯？</span></a></li><li><a href="/blog-other/物联网开发实战/01.2022特别加更/03"><span>实战二｜MQTT开发：如何实现联网控制？</span></a></li><li><a href="/blog-other/物联网开发实战/01.2022特别加更/04"><span>假期快乐｜这是一份暂时停更的声明</span></a></li></ul></li><li><a href="/blog-other/物联网开发实战/02.开篇词">02.开篇词</a><ul><li><a href="/blog-other/物联网开发实战/02.开篇词/01"><span>开篇词 | 物联网这个趋势，你不应该错过</span></a></li></ul></li><li><a href="/blog-other/物联网开发实战/03.基础篇">03.基础篇</a><ul><li><a href="/blog-other/物联网开发实战/03.基础篇/01"><span>01 | 入门介绍：如何定义物联网？</span></a></li><li><a href="/blog-other/物联网开发实战/03.基础篇/02"><span>02 | 通信技术：设备接入网络的方式有哪些？</span></a></li><li><a href="/blog-other/物联网开发实战/03.基础篇/03"><span>03 | 网络协议：设备使用什么语言与互联网对话？</span></a></li><li><a href="/blog-other/物联网开发实战/03.基础篇/04"><span>04 | 数据分析：数据的价值有哪些？</span></a></li><li><a href="/blog-other/物联网开发实战/03.基础篇/05"><span>05 | 系统实例：怎样设计一个简易物联网系统？</span></a></li></ul></li><li><a href="/blog-other/物联网开发实战/04.进阶篇">04.进阶篇</a><ul><li><a href="/blog-other/物联网开发实战/04.进阶篇/01"><span>06 | 物模型：如何定义智能电灯？</span></a></li><li><a href="/blog-other/物联网开发实战/04.进阶篇/02"><span>07 | 零配置组网：设备如何发现彼此？</span></a></li><li><a href="/blog-other/物联网开发实战/04.进阶篇/03"><span>08 | MQTT：在实践中掌握一个通信协议</span></a></li><li><a href="/blog-other/物联网开发实战/04.进阶篇/04"><span>09 | 边缘中心：物联网网关有多重要？</span></a></li><li><a href="/blog-other/物联网开发实战/04.进阶篇/05"><span>10 | 数据处理框架：批处理还是流处理？</span></a></li><li><a href="/blog-other/物联网开发实战/04.进阶篇/06"><span>11 | 数据存储：物联网中的数据库有哪些？</span></a></li><li><a href="/blog-other/物联网开发实战/04.进阶篇/07"><span>12 | IoT Hub：面对海量设备如何打造高性能设备接入层？</span></a></li><li><a href="/blog-other/物联网开发实战/04.进阶篇/08"><span>13 | 隐私：在实践中如何保护用户隐私？</span></a></li><li><a href="/blog-other/物联网开发实战/04.进阶篇/09"><span>14 | 安全：物联网平台如何应对安全风险？</span></a></li><li><a href="/blog-other/物联网开发实战/04.进阶篇/10"><span>15 | 平台：智能家居开源平台的生态是怎样的？</span></a></li></ul></li><li><a aria-current="page" class="active" href="/blog-other/物联网开发实战/05.实战篇">05.实战篇</a><ul><li><a href="/blog-other/物联网开发实战/05.实战篇/01"><span>16 | 实战准备：如何搭建硬件开发环境？</span></a></li><li><a href="/blog-other/物联网开发实战/05.实战篇/02"><span>17 | 远程控制：怎样打造联网的智能电灯？</span></a></li><li><a href="/blog-other/物联网开发实战/05.实战篇/03"><span>18 | 场景联动：智能电灯如何感知光线？（上）</span></a></li><li><a aria-current="page" class="active" href="/blog-other/物联网开发实战/05.实战篇/04"><span>19 | 场景联动：智能电灯如何感知光线？（下）</span></a></li><li><a href="/blog-other/物联网开发实战/05.实战篇/05"><span>20 | 智能语音：好玩的语音控制是怎么实现的？</span></a></li><li><a href="/blog-other/物联网开发实战/05.实战篇/06"><span>21 | 多传感器集成：浇花怎么实现自动化？</span></a></li><li><a href="/blog-other/物联网开发实战/05.实战篇/07"><span>22 | 掌控数据：家里的数据可以怎么利用？</span></a></li></ul></li><li><a href="/blog-other/物联网开发实战/06.结束语">06.结束语</a><ul><li><a href="/blog-other/物联网开发实战/06.结束语/01"><span>结束语 | 永远做一个具有极客精神的人</span></a></li></ul></li><li><a href="/blog-other/物联网开发实战/07.测试题">07.测试题</a><ul><li><a href="/blog-other/物联网开发实战/07.测试题/01"><span>结课测试 | 这些物联网的问题，你都掌握了吗？</span></a></li></ul></li><li><a href="/blog-other/物联网开发实战/08.加餐">08.加餐</a><ul><li><a href="/blog-other/物联网开发实战/08.加餐/01"><span>加餐一 | 这5本关于物联网的好书，值得一读</span></a></li><li><a href="/blog-other/物联网开发实战/08.加餐/02"><span>加餐二 | 行业应用：物联网的发展将如何重塑我们的生活？</span></a></li><li><a href="/blog-other/物联网开发实战/08.加餐/03"><span>加餐三 | 行业应用：物联网的发展将如何升级第一、第二产业？</span></a></li><li><a href="/blog-other/物联网开发实战/08.加餐/04"><span>加餐四 | 5G技术将如何推动物联网的发展？</span></a></li><li><a href="/blog-other/物联网开发实战/08.加餐/05"><span>加餐五 | 投身物联网行业，如何做好职业规划？</span></a></li></ul></li><li><a href="/blog-other/物联网开发实战/09.用户故事">09.用户故事</a><ul><li><a href="/blog-other/物联网开发实战/09.用户故事/01"><span>用户故事 | 让野蛮生长成为职业发展的助推剂</span></a></li><li><a href="/blog-other/物联网开发实战/09.用户故事/02"><span>用户故事 | 转战物联网，我相信天道酬勤</span></a></li></ul></li><li><a href="/blog-other/物联网开发实战/summary">物联网开发实战</a></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="网关系统架构" data-depth="2"><a href="/blog-other/物联网开发实战/05.实战篇/04#网关系统架构"><span>网关系统架构</span></a></li><li title="南向蓝牙通信" data-depth="2"><a href="/blog-other/物联网开发实战/05.实战篇/04#南向蓝牙通信"><span>南向蓝牙通信</span></a></li><li title="通过终端登录树莓派" data-depth="3"><a href="/blog-other/物联网开发实战/05.实战篇/04#通过终端登录树莓派"><span>通过终端登录树莓派</span></a></li><li title="通过图形化窗口软件登录树莓派" data-depth="3"><a href="/blog-other/物联网开发实战/05.实战篇/04#通过图形化窗口软件登录树莓派"><span>通过图形化窗口软件登录树莓派</span></a></li><li title="在树莓派开发蓝牙程序" data-depth="3"><a href="/blog-other/物联网开发实战/05.实战篇/04#在树莓派开发蓝牙程序"><span>在树莓派开发蓝牙程序</span></a></li><li title="北向MQTT对接云平台" data-depth="2"><a href="/blog-other/物联网开发实战/05.实战篇/04#北向mqtt对接云平台"><span>北向MQTT对接云平台</span></a></li><li title="MQTT开发环境准备" data-depth="3"><a href="/blog-other/物联网开发实战/05.实战篇/04#mqtt开发环境准备"><span>MQTT开发环境准备</span></a></li><li title="云平台创建光照传感器设备" data-depth="3"><a href="/blog-other/物联网开发实战/05.实战篇/04#云平台创建光照传感器设备"><span>云平台创建光照传感器设备</span></a></li><li title="产品联网开发" data-depth="3"><a href="/blog-other/物联网开发实战/05.实战篇/04#产品联网开发"><span>产品联网开发</span></a></li><li title="在树莓派上部署软件" data-depth="3"><a href="/blog-other/物联网开发实战/05.实战篇/04#在树莓派上部署软件"><span>在树莓派上部署软件</span></a></li><li title="设置场景联动" data-depth="2"><a href="/blog-other/物联网开发实战/05.实战篇/04#设置场景联动"><span>设置场景联动</span></a></li><li title="场景联动任务分解" data-depth="3"><a href="/blog-other/物联网开发实战/05.实战篇/04#场景联动任务分解"><span>场景联动任务分解</span></a></li><li title="联动设备准备" data-depth="3"><a href="/blog-other/物联网开发实战/05.实战篇/04#联动设备准备"><span>联动设备准备</span></a></li><li title="联动任务创建" data-depth="3"><a href="/blog-other/物联网开发实战/05.实战篇/04#联动任务创建"><span>联动任务创建</span></a></li><li title="小结" data-depth="2"><a href="/blog-other/物联网开发实战/05.实战篇/04#小结"><span>小结</span></a></li><li title="思考题" data-depth="2"><a href="/blog-other/物联网开发实战/05.实战篇/04#思考题"><span>思考题</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="19--场景联动智能电灯如何感知光线下"><a aria-hidden="true" tabindex="-1" href="/blog-other/物联网开发实战/05.实战篇/04#19--场景联动智能电灯如何感知光线下"><span class="icon icon-link"></span></a>19 | 场景联动：智能电灯如何感知光线？（下）</h1><p>你好，我是郭朝斌。</p><p>在上一讲，我们基于NodeMCU ESP32开发板，开发了一款光照传感器。考虑到低功耗的需求，它是基于低功耗蓝牙技术来实现的。但是蓝牙设备本身无法直接联网上报数据，那么我们要怎么根据光照强度数据来联动控制智能电灯呢？</p><p>不知道你还记不记得<a target="_blank" rel="noopener noreferrer" href="https://time.geekbang.org/column/article/313631">第9讲<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>的内容？对于蓝牙设备，我们需要借助<strong>网关</strong>来实现联网的目的。所以在这一讲中，我会带你用树莓派打造蓝牙网关，最终实现光照传感器和智能电灯的场景联动（如有需要，你可以根据<a target="_blank" rel="noopener noreferrer" href="https://shimo.im/sheets/D3VVPdwcYRhhQRXh/MODOC">这份文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>自行采购相关硬件）。</p><h2 id="网关系统架构"><a aria-hidden="true" tabindex="-1" href="/blog-other/物联网开发实战/05.实战篇/04#网关系统架构"><span class="icon icon-link"></span></a>网关系统架构</h2><p>首先，我们先看一下网关的系统架构。</p><p>网关的主要功能是<strong>协议转换</strong>，一方面它需要接收低功耗蓝牙技术的光照传感器的广播数据，另一方面，它需要把解析的数据上传到云平台。</p><p>具体的架构图如下所示。</p><p><img src="/blog-other/static/httpsstatic001geekbangorgresourceimagee444e44a8bfe765e535f320568f57a3cfa44.db624e05.jpg" alt="19.01"/></p><h2 id="南向蓝牙通信"><a aria-hidden="true" tabindex="-1" href="/blog-other/物联网开发实战/05.实战篇/04#南向蓝牙通信"><span class="icon icon-link"></span></a>南向蓝牙通信</h2><p>在树莓派上进行蓝牙开发，你可以使用<a target="_blank" rel="noopener noreferrer" href="https://github.com/IanHarvey/bluepy">bluepy<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>软件包。它提供了一个Python语言版本的低功耗蓝牙API接口，而且对树莓派的适配非常好。</p><h3 id="通过终端登录树莓派"><a aria-hidden="true" tabindex="-1" href="/blog-other/物联网开发实战/05.实战篇/04#通过终端登录树莓派"><span class="icon icon-link"></span></a>通过终端登录树莓派</h3><p>在学习<a target="_blank" rel="noopener noreferrer" href="https://time.geekbang.org/column/article/320675">第15讲<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>的时候，你应该已经在树莓派上部署好了包含Gladys Assistant系统的Raspbian操作系统，现在你可以直接使用这个系统。安装软件包之前，我们在电脑终端上输入下面的命令，通过SSH协议登录到树莓派系统中。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ ssh pi@gladys.local</span></div></pre></div><p>其中，pi就是默认的登录用户名，gladys.local是树莓派开发板的本地域名。</p><p>当提示输入密码时，我们输入默认密码raspberry，然后回车，就登录到了树莓派系统中。</p><p><img src="/blog-other/static/httpsstatic001geekbangorgresourceimage91819171ef2f8a94c6ee8d1869d571677781.8990c384.png" alt="19.02"/></p><h3 id="通过图形化窗口软件登录树莓派"><a aria-hidden="true" tabindex="-1" href="/blog-other/物联网开发实战/05.实战篇/04#通过图形化窗口软件登录树莓派"><span class="icon icon-link"></span></a>通过图形化窗口软件登录树莓派</h3><p>当然，你也可以使用提供图形化窗口的软件来登录树莓派，比如<strong>SecureCRT</strong>，它除了支持串口协议，同时也支持SSH协议。你只需要新建一个连接会话，按照下图所示的内容填写就行了：</p><p><img src="/blog-other/static/httpsstatic001geekbangorgresourceimagef357f39028873bb6ce7d99f411881f4a3357.e3504526.png" alt="19.03"/></p><p>第一次登录时，SecureCRT会弹窗提示我们查看“Host Key”，这时点击“Accept Once”即可。</p><p><img src="/blog-other/static/httpsstatic001geekbangorgresourceimage7859786bd55b06ea8c11d3171fb57ddec459.ab1cc71f.png" alt="19.04"/></p><p>然后我们输入密码“raspberry”，同时勾选“Save password”，省去以后重复输入密码的麻烦。点击“OK”后，就进入树莓派系统了。</p><p><img src="/blog-other/static/httpsstatic001geekbangorgresourceimage4aee4af7047e2d3yy7a2dfa511628708a1ee.b7c66f05.png" alt="19.05"/></p><h3 id="在树莓派开发蓝牙程序"><a aria-hidden="true" tabindex="-1" href="/blog-other/物联网开发实战/05.实战篇/04#在树莓派开发蓝牙程序"><span class="icon icon-link"></span></a>在树莓派开发蓝牙程序</h3><p>我们在树莓派的终端上输入下面命令，就可以完成bluepy的安装：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ sudo apt-get install python3-pip libglib2.0-dev</span></div><div class="token-line"><span class="token plain">    $ sudo pip3 install bluepy</span></div></pre></div><p>另外，我们还需要安装interruptingcow软件包。它主要是便于编写定时任务。它的安装命令是：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ sudo pip3 install interruptingcow</span></div></pre></div><p>具体代码如下，供参考：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">#File: blescan.py</span></div><div class="token-line"><span class="token plain">    import time</span></div><div class="token-line"><span class="token plain">    from threading import Thread</span></div><div class="token-line"><span class="token plain">    from interruptingcow import timeout</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    from bluepy.btle import DefaultDelegate, Peripheral, Scanner, UUID, capitaliseName, BTLEInternalError</span></div><div class="token-line"><span class="token plain">    from bluepy.btle import BTLEDisconnectError, BTLEManagementError, BTLEGattError</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    class LightScanner():</span></div><div class="token-line"><span class="token plain">        SCAN_TIMEOUT = 5</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        def __init__(self, name):</span></div><div class="token-line"><span class="token plain">            self._name = name</span></div><div class="token-line"><span class="token plain">        </span></div><div class="token-line"><span class="token plain">        def status_update(self):</span></div><div class="token-line"><span class="token plain">            results = self._get_data()</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">            # messages = [</span></div><div class="token-line"><span class="token plain">            #     MqttMessage(</span></div><div class="token-line"><span class="token plain">            #         topic=self.format_topic(&quot;property/light&quot;),</span></div><div class="token-line"><span class="token plain">            #         payload=results.lightlevel,</span></div><div class="token-line"><span class="token plain">            #     )</span></div><div class="token-line"><span class="token plain">            # ]</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">            return results</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        def _get_data(self):</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">            scan_processor = ScanProcessor(self._name)</span></div><div class="token-line"><span class="token plain">            scanner = Scanner().withDelegate(scan_processor)</span></div><div class="token-line"><span class="token plain">            scanner.scan(self.SCAN_TIMEOUT, passive=True)</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">            with timeout(</span></div><div class="token-line"><span class="token plain">                self.SCAN_TIMEOUT,</span></div><div class="token-line"><span class="token plain">                exception=Exception(</span></div><div class="token-line"><span class="token plain">                    &quot;Retrieving data from {} device {} timed out after {} seconds&quot;.format(</span></div><div class="token-line"><span class="token plain">                        repr(self), self._name, self.SCAN_TIMEOUT</span></div><div class="token-line"><span class="token plain">                    )</span></div><div class="token-line"><span class="token plain">                ),</span></div><div class="token-line"><span class="token plain">            ):</span></div><div class="token-line"><span class="token plain">                while not scan_processor.ready:</span></div><div class="token-line"><span class="token plain">                    time.sleep(1)</span></div><div class="token-line"><span class="token plain">                return scan_processor.results</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">            return scan_processor.results</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    class ScanProcessor:</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        ADV_TYPE_SERVICE_DATA = 0x16</span></div><div class="token-line"><span class="token plain">        def __init__(self, name):</span></div><div class="token-line"><span class="token plain">            self._ready = False</span></div><div class="token-line"><span class="token plain">            self._name = name</span></div><div class="token-line"><span class="token plain">            self._results = MiBeaconData()</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        def handleDiscovery(self, dev, isNewDev, _):</span></div><div class="token-line"><span class="token plain">            is_nodemcu = False</span></div><div class="token-line"><span class="token plain">            if isNewDev:</span></div><div class="token-line"><span class="token plain">                for (adtype, desc, value) in dev.getScanData():</span></div><div class="token-line"><span class="token plain">                    #Service Data UUID == 0xFE95 according to MiBeacon</span></div><div class="token-line"><span class="token plain">                    if adtype == self.ADV_TYPE_SERVICE_DATA and value.startswith(&quot;95fe&quot;):</span></div><div class="token-line"><span class="token plain">                        print(&quot;FOUND service Data:&quot;,adtype, desc, value)</span></div><div class="token-line"><span class="token plain">                        #Object ID == 0x1007 according to MiBeacon</span></div><div class="token-line"><span class="token plain">                        if len(value) == 38 and value[26:30] == &#x27;0710&#x27;:</span></div><div class="token-line"><span class="token plain">                            light_den = int((value[-2:] + value[-4:-2]), 16)</span></div><div class="token-line"><span class="token plain">                            mac = value[14:26]</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">                            self._results.lightlevel = light_den</span></div><div class="token-line"><span class="token plain">                            self._results.mac = mac</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">                            self.ready = True</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        @property</span></div><div class="token-line"><span class="token plain">        def mac(self):</span></div><div class="token-line"><span class="token plain">            return self._mac</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        @property</span></div><div class="token-line"><span class="token plain">        def ready(self):</span></div><div class="token-line"><span class="token plain">            return self._ready</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        @ready.setter</span></div><div class="token-line"><span class="token plain">        def ready(self, var):</span></div><div class="token-line"><span class="token plain">            self._ready = var</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        @property</span></div><div class="token-line"><span class="token plain">        def results(self):</span></div><div class="token-line"><span class="token plain">            return self._results</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    class MiBeaconData:</span></div><div class="token-line"><span class="token plain">        def __init__(self):</span></div><div class="token-line"><span class="token plain">            self._lightlevel = None</span></div><div class="token-line"><span class="token plain">            self._mac = None</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        @property</span></div><div class="token-line"><span class="token plain">        def lightlevel(self):</span></div><div class="token-line"><span class="token plain">            return self._lightlevel</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        @lightlevel.setter</span></div><div class="token-line"><span class="token plain">        def lightlevel(self, var):</span></div><div class="token-line"><span class="token plain">            self._lightlevel = var</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        @property</span></div><div class="token-line"><span class="token plain">        def mac(self):</span></div><div class="token-line"><span class="token plain">            return self._mac</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        @mac.setter</span></div><div class="token-line"><span class="token plain">        def mac(self, var):</span></div><div class="token-line"><span class="token plain">            self._mac = var</span></div></pre></div><h2 id="北向mqtt对接云平台"><a aria-hidden="true" tabindex="-1" href="/blog-other/物联网开发实战/05.实战篇/04#北向mqtt对接云平台"><span class="icon icon-link"></span></a>北向MQTT对接云平台</h2><p>接下来，我们要实现网关和云平台的对接。</p><h3 id="mqtt开发环境准备"><a aria-hidden="true" tabindex="-1" href="/blog-other/物联网开发实战/05.实战篇/04#mqtt开发环境准备"><span class="icon icon-link"></span></a>MQTT开发环境准备</h3><ol><li><strong>安装软件包</strong></li></ol><p>蓝牙网关与云平台交互的通信协议也是使用MQTT协议，所以我们需要安装MQTT的软件包。</p><p>使用哪个软件包呢？在<a target="_blank" rel="noopener noreferrer" href="https://time.geekbang.org/column/article/312691">第8讲<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>中我介绍过几个常用的MQTT软件包，这里我们选择支持Python语言开发的<a target="_blank" rel="noopener noreferrer" href="http://www.eclipse.org/paho/">Eclipse Paho<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>软件包。我们在树莓派的终端上输入下面的命令来安装。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ sudo pip3 install paho-mqtt</span></div></pre></div><p>安装成功后，我们可以写一个demo程序测试一下。下面是我测试的代码，你可以参考。和第8讲一样，这段代码仍然会连接到 test.mosquitto.org，并且订阅“/geektime/iot”的主题消息。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">#File: mqttdemo.py </span></div><div class="token-line"><span class="token plain">    import paho.mqtt.client as mqtt</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    def on_connect(client, userdata, flags, rc):</span></div><div class="token-line"><span class="token plain">        print(&quot;Connected with result code &quot;+str(rc))</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        client.subscribe(&quot;/geektime/iot&quot;)</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    def on_message(client, userdata, msg):</span></div><div class="token-line"><span class="token plain">        print(msg.topic+&quot; &quot;+str(msg.payload))</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    client = mqtt.Client()</span></div><div class="token-line"><span class="token plain">    client.on_connect = on_connect</span></div><div class="token-line"><span class="token plain">    client.on_message = on_message</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    #Still connect to mqtt.eclipse.org</span></div><div class="token-line"><span class="token plain">    client.connect(&quot;test.mosquitto.org&quot;, 1883, 60)</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    client.loop_forever()</span></div></pre></div><ol start="2"><li><strong>部署文件到树莓派</strong></li></ol><p>现在，我们把测试文件 mqttdemo.py 上传到树莓派上。</p><p>你可以在电脑终端上，运行下面的命令。（注意，你需要先在树莓派上创建 pi-gateway 这个目录。）</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ scp mqttdemo.py pi@gladys.local:/home/pi/pi-gateway/</span></div></pre></div><p>其中这个scp命令是基于SSH协议实现的安全文档传输功能。</p><p>当然，你也可能更习惯图形化的软件，所以我再介绍一个能实现scp功能的软件 <a target="_blank" rel="noopener noreferrer" href="https://filezilla-project.org/download.php?type=client">FileZilla<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。它支持MacOS、Windows和Linux操作系统，操作界面也非常直观。</p><p>打开“站点管理器”，创建“新站点”。你可以按照下图设置具体配置参数，然后点击“连接”，登录到树莓派系统。为了方便之后的使用，你可以勾选“保存密码”选项。</p><p><img src="/blog-other/static/httpsstatic001geekbangorgresourceimage299029db1ea1b71c06b0845b82bbefc72190.ac8e1d3f.png" alt="19.06"/></p><p>在软件界面的左半部分是你的电脑上的文件目录，右半部分是树莓派上的目录。你只需要双击左边的某个文件，就可以将文件传输到树莓派上。当然你也可以双击右边树莓派上的文件，将它传输到你的电脑。</p><p><img src="/blog-other/static/httpsstatic001geekbangorgresourceimageaa69aa1b5c0538b4f62f33ce6ed22c77a469.9de27875.png" alt="19.07"/></p><p>把文件传输到树莓派之后，我们就可以在树莓派的终端上输入下面的命令，运行上面的demo程序。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ sudo python3 mqttdemo.py</span></div></pre></div><p>这时我们把<a target="_blank" rel="noopener noreferrer" href="https://time.geekbang.org/column/article/312691">第8讲<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>中的发布消息命令再执行一次，如果一切顺利执行，那么就可以在树莓派的终端上看到这个消息。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">hbmqtt_pub --url mqtt://test.mosquitto.org:1883 -t /geektime/iot -m Hello,World!</span></div></pre></div><p><img src="/blog-other/static/httpsstatic001geekbangorgresourceimage16b716e0b2312275956965643dc825ff17b7.b199cafa.png" alt="19.08"/></p><h3 id="云平台创建光照传感器设备"><a aria-hidden="true" tabindex="-1" href="/blog-other/物联网开发实战/05.实战篇/04#云平台创建光照传感器设备"><span class="icon icon-link"></span></a>云平台创建光照传感器设备</h3><p>现在，我们已经做好了对接云平台的准备工作。在树莓派上开发与云平台的通信代码之前，我们还需要在腾讯云平台上创建对应的光照传感器设备。</p><p>创建的过程与第17讲智能电灯的过程类似。我快速介绍一下，你重点关注不同的地方就可以了。</p><p>在“新建产品”中，产品类别选择“智慧生活”--&gt;“安防报警”--&gt;“光照度传感器”。数据协议仍然选择“数据模板”，其他的保持默认值即可。</p><p><img src="/blog-other/static/httpsstatic001geekbangorgresourceimagea137a15fc960131a83818be3f979044b0037.243e955e.png" alt="19.09"/></p><p>创建成功后，我们点击进入数据模板的设置界面。为了尽量简单，我只定义了一个属性“光照度”，而且是只读类型。你可以直接导入下面的JSON文件完成数据模板的设置。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">{</span></div><div class="token-line"><span class="token plain">      &quot;version&quot;: &quot;1.0&quot;,</span></div><div class="token-line"><span class="token plain">      &quot;profile&quot;: {</span></div><div class="token-line"><span class="token plain">        &quot;ProductId&quot;: &quot;你的ProductID&quot;,</span></div><div class="token-line"><span class="token plain">        &quot;CategoryId&quot;: &quot;112&quot;</span></div><div class="token-line"><span class="token plain">      },</span></div><div class="token-line"><span class="token plain">      &quot;properties&quot;: [</span></div><div class="token-line"><span class="token plain">        {</span></div><div class="token-line"><span class="token plain">          &quot;id&quot;: &quot;Illuminance&quot;,</span></div><div class="token-line"><span class="token plain">          &quot;name&quot;: &quot;光照度&quot;,</span></div><div class="token-line"><span class="token plain">          &quot;desc&quot;: &quot;光照度检测&quot;,</span></div><div class="token-line"><span class="token plain">          &quot;mode&quot;: &quot;r&quot;,</span></div><div class="token-line"><span class="token plain">          &quot;define&quot;: {</span></div><div class="token-line"><span class="token plain">            &quot;type&quot;: &quot;float&quot;,</span></div><div class="token-line"><span class="token plain">            &quot;min&quot;: &quot;0&quot;,</span></div><div class="token-line"><span class="token plain">            &quot;max&quot;: &quot;6000&quot;,</span></div><div class="token-line"><span class="token plain">            &quot;start&quot;: &quot;0&quot;,</span></div><div class="token-line"><span class="token plain">            &quot;step&quot;: &quot;1&quot;,</span></div><div class="token-line"><span class="token plain">            &quot;unit&quot;: &quot;Lux&quot;</span></div><div class="token-line"><span class="token plain">          }</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">      ],</span></div><div class="token-line"><span class="token plain">      &quot;events&quot;: [],</span></div><div class="token-line"><span class="token plain">      &quot;actions&quot;: []</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p><img src="/blog-other/static/httpsstatic001geekbangorgresourceimage77da779d9d3f3c5f35a1490bbe91f2f4b7da.011540e0.png" alt="19.10"/></p><p>在“交互开发”标签页中，和智能电灯一样，我们仍然保持“使用官方小程序控制产品”选项是打开状态。另外，还有一个配置项需要关注，那就是“智能联动配置”，因为后面我们要为光照传感器设置联动场景。</p><p><img src="/blog-other/static/httpsstatic001geekbangorgresourceimage767a76c20e82ae392b96e52a0467381fbc7a.62477617.png" alt="19.11"/></p><p>我们点击“配置”，在设置页面中，就可以看到“光照度”这个属性，因为它是只读属性，所以只能作为联动的触发条件。我们勾选“作为条件”的选项，完成配置。</p><p><img src="/blog-other/static/httpsstatic001geekbangorgresourceimage3977395790a876a9e616dafc107dcf872177.484b5f9c.png" alt="19.12"/></p><p>下一步，在“设备调试”界面中，我们创建一个测试设备。点击“新建设备”，输入设备名称“Lightsensor_1”。</p><p><img src="/blog-other/static/httpsstatic001geekbangorgresourceimageff2aff73e5da081e581cb8cb1229e08e302a.e419f505.png" alt="19.13"/></p><p>创建成功后，在测试设备列表中，点击“Lightsensor_1”，进入设备的详情页面，我们可以看到设备三元组的信息。你需要将这些信息记录下来，因为后面的开发中需要使用。</p><p>在测试设备列表中，我们点击“二维码”操作，获取测试设备的二维码，以便在小程序“腾讯连连”中添加这个设备。</p><p>到这里，腾讯云平台上的产品创建工作就完成了。</p><h3 id="产品联网开发"><a aria-hidden="true" tabindex="-1" href="/blog-other/物联网开发实战/05.实战篇/04#产品联网开发"><span class="icon icon-link"></span></a>产品联网开发</h3><p>在腾讯云平台准备好产品的配置工作之后，我们继续在树莓派上完成北向的通信交互的开发工作。</p><p>在<a target="_blank" rel="noopener noreferrer" href="https://time.geekbang.org/column/article/322528">第17讲<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>中，我们已经了解了MQTT通信的主题 Topic ，以及 Broker 服务器地址、端口号、设备ID（ClientID）、用户名（UserName）和密码（Password）等连接参数的知识。</p><p>我们还是可以使用<strong>sign.html</strong>这个网页工具生产用户名和密码，然后就能得到所有的参数。这时，把这些参数替换到下面这段代码的对应位置就可以了。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">#File: gateway.py</span></div><div class="token-line"><span class="token plain">    from blescan import LightScanner, MiBeaconData</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    import time </span></div><div class="token-line"><span class="token plain">    import asyncio</span></div><div class="token-line"><span class="token plain">    import json</span></div><div class="token-line"><span class="token plain">    import uuid</span></div><div class="token-line"><span class="token plain">    import paho.mqtt.client as MQTTClient</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    &quot;&quot;&quot;</span></div><div class="token-line"><span class="token plain">    QCloud Device Info</span></div><div class="token-line"><span class="token plain">    &quot;&quot;&quot;</span></div><div class="token-line"><span class="token plain">    DEVICE_NAME = &quot;Lightsensor_1&quot;</span></div><div class="token-line"><span class="token plain">    PRODUCT_ID = &quot;MAO3SVUCFO&quot;</span></div><div class="token-line"><span class="token plain">    DEVICE_KEY = &quot;TYjuKNc2GpDykXUv4MWBOA==&quot;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    &quot;&quot;&quot;</span></div><div class="token-line"><span class="token plain">    MQTT topic</span></div><div class="token-line"><span class="token plain">    &quot;&quot;&quot;</span></div><div class="token-line"><span class="token plain">    MQTT_CONTROL_TOPIC = &quot;$thing/down/property/&quot;+PRODUCT_ID+&quot;/&quot;+DEVICE_NAME</span></div><div class="token-line"><span class="token plain">    MQTT_CONTROL_REPLY_TOPIC = &quot;$thing/up/property/&quot;+PRODUCT_ID+&quot;/&quot;+DEVICE_NAME</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    def mqtt_callback(client, userdata, msg):</span></div><div class="token-line"><span class="token plain">        # Callback</span></div><div class="token-line"><span class="token plain">        print(f&quot;Received `{msg.payload.decode()}` from `{msg.topic}` topic&quot;)</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    async def mqtt_connect():</span></div><div class="token-line"><span class="token plain">        #connect callback</span></div><div class="token-line"><span class="token plain">        def on_connect(client, userdata, flags, rc):</span></div><div class="token-line"><span class="token plain">            if rc == 0:</span></div><div class="token-line"><span class="token plain">                print(&quot;Connected to MQTT Broker!&quot;)</span></div><div class="token-line"><span class="token plain">            else:</span></div><div class="token-line"><span class="token plain">                print(&quot;Failed to connect, return code %d\n&quot;, rc)</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        mqtt_client = None</span></div><div class="token-line"><span class="token plain">        MQTT_SERVER = PRODUCT_ID + &quot;.iotcloud.tencentdevices.com&quot;</span></div><div class="token-line"><span class="token plain">        MQTT_PORT = 1883</span></div><div class="token-line"><span class="token plain">        MQTT_CLIENT_ID = PRODUCT_ID+DEVICE_NAME</span></div><div class="token-line"><span class="token plain">        MQTT_USER_NAME = &quot;MAO3SVUCFOLightsensor_1;12010126;2OYA5;1609057368&quot;</span></div><div class="token-line"><span class="token plain">        MQTTT_PASSWORD = &quot;8f79b7f1b0bef9cde7fd9652383b6ff8bfeb8003cc994c64f3c8e069c11fd4c7;hmacsha256&quot;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        mqtt_client = MQTTClient.Client(MQTT_CLIENT_ID)</span></div><div class="token-line"><span class="token plain">        mqtt_client.username_pw_set(MQTT_USER_NAME, MQTTT_PASSWORD)</span></div><div class="token-line"><span class="token plain">        mqtt_client.on_connect = on_connect</span></div><div class="token-line"><span class="token plain">        </span></div><div class="token-line"><span class="token plain">        mqtt_client.connect(MQTT_SERVER, MQTT_PORT, 60)</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        return mqtt_client</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    def mqtt_report(client, light_level):</span></div><div class="token-line"><span class="token plain">        client_token = &quot;clientToken-&quot; + str(uuid.uuid4())</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        msg = {</span></div><div class="token-line"><span class="token plain">            &quot;method&quot;: &quot;report&quot;,</span></div><div class="token-line"><span class="token plain">            &quot;clientToken&quot;: client_token,</span></div><div class="token-line"><span class="token plain">            &quot;params&quot;: {</span></div><div class="token-line"><span class="token plain">                &quot;Illuminance&quot;: light_level</span></div><div class="token-line"><span class="token plain">            }</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        client.publish(MQTT_CONTROL_REPLY_TOPIC, json.dumps(msg))</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    async def light_loop(mclient):</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        bles = LightScanner(&#x27;Nodemcu&#x27;)</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        mclient.subscribe(MQTT_CONTROL_TOPIC)</span></div><div class="token-line"><span class="token plain">        mclient.on_message = mqtt_callback</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        mclient.loop_start()</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        while True:</span></div><div class="token-line"><span class="token plain">            try:</span></div><div class="token-line"><span class="token plain">                data = bles.status_update()</span></div><div class="token-line"><span class="token plain">            except Exception as e:</span></div><div class="token-line"><span class="token plain">                print(&quot;BLE SCAN error:&quot;, e)</span></div><div class="token-line"><span class="token plain">                continue</span></div><div class="token-line"><span class="token plain">            </span></div><div class="token-line"><span class="token plain">            print(&quot;Light Level:&quot;, data.lightlevel)</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">            mqtt_report(mclient, data.lightlevel)</span></div><div class="token-line"><span class="token plain">            </span></div><div class="token-line"><span class="token plain">            time.sleep(0.1)</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    async def main():</span></div><div class="token-line"><span class="token plain">        mqtt_client = None</span></div><div class="token-line"><span class="token plain">        # MQTT connection</span></div><div class="token-line"><span class="token plain">        try:</span></div><div class="token-line"><span class="token plain">            mqtt_client = await asyncio.wait_for(mqtt_connect(), 20)</span></div><div class="token-line"><span class="token plain">        except asyncio.TimeoutError:</span></div><div class="token-line"><span class="token plain">            print(&quot;mqtt connected timeout!&quot;)</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        if mqtt_client is not None:</span></div><div class="token-line"><span class="token plain">            await asyncio.gather(light_loop(mqtt_client))</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    asyncio.run(main())</span></div></pre></div><h3 id="在树莓派上部署软件"><a aria-hidden="true" tabindex="-1" href="/blog-other/物联网开发实战/05.实战篇/04#在树莓派上部署软件"><span class="icon icon-link"></span></a>在树莓派上部署软件</h3><p>接下来，我们把代码文件gateway.py 和 blescan.py 两个文件也上传到树莓派的/home/pi/pi-gateway目录中。</p><p>同时，为了让程序作为后台服务运行，并且能够开机自启动，我们来做一个Pi Gateway Service。</p><p>首先，你需要新建一个service.sh脚本文件，内容如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">#!/bin/sh</span></div><div class="token-line"><span class="token plain">    set -e</span></div><div class="token-line"><span class="token plain">    SCRIPT_DIR=$( cd &quot;$( dirname &quot;$0&quot; )&quot; &gt;/dev/null 2&gt;&amp;1 &amp;&amp; pwd )</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    cd &quot;$SCRIPT_DIR&quot;</span></div><div class="token-line"><span class="token plain">    sudo python3 ./gateway.py &quot;$@&quot;</span></div></pre></div><p>然后，创建我们service的配置文件，内容如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">[Unit]</span></div><div class="token-line"><span class="token plain">    Description=Pi Gateway</span></div><div class="token-line"><span class="token plain">    Documentation=https://time.geekbang.org/column/intro/100063601</span></div><div class="token-line"><span class="token plain">    After=network.target</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    [Service]</span></div><div class="token-line"><span class="token plain">    Type=simple</span></div><div class="token-line"><span class="token plain">    WorkingDirectory=/home/pi/pi-gateway</span></div><div class="token-line"><span class="token plain">    ExecStart=/home/pi/pi-gateway/service.sh</span></div><div class="token-line"><span class="token plain">    Restart=always</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    [Install]</span></div><div class="token-line"><span class="token plain">    WantedBy=multi-user.target</span></div></pre></div><p>接着，把这两个文件上传到树莓派系统的/home/pi/pi-gateway目录中，并且运行下面命令，修改文件的属性。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ sudo chmod a+x service.sh </span></div><div class="token-line"><span class="token plain">    $ sudo chmod a+x pi-gateway.service</span></div></pre></div><p>最后，执行下面的几条命令，为树莓派系统增添上 Pi Gateway 这个服务。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ sudo cp /home/pi/pi-gateway/pi-gateway.service /etc/systemd/system/</span></div><div class="token-line"><span class="token plain">    $ sudo systemctl daemon-reload</span></div><div class="token-line"><span class="token plain">    $ sudo systemctl start pi-gateway</span></div><div class="token-line"><span class="token plain">    $ sudo systemctl status pi-gateway</span></div><div class="token-line"><span class="token plain">    $ sudo systemctl enable pi-gateway</span></div></pre></div><p>到这里，网关程序已经在树莓派上运行起来。我们在腾讯云物联网平台上可以看到，光照传感器变为“在线”状态。</p><h2 id="设置场景联动"><a aria-hidden="true" tabindex="-1" href="/blog-other/物联网开发实战/05.实战篇/04#设置场景联动"><span class="icon icon-link"></span></a>设置场景联动</h2><p>在第17讲和第18讲的实战中，我们分别完成了智能电灯和光照传感器的开发，现在终于可以为它们设置场景联动了。</p><h3 id="场景联动任务分解"><a aria-hidden="true" tabindex="-1" href="/blog-other/物联网开发实战/05.实战篇/04#场景联动任务分解"><span class="icon icon-link"></span></a>场景联动任务分解</h3><p>我们希望实现的联动场景是，基于环境的光照强度自动控制电灯的开和关。具体来说，这个目标可以拆解为3个自动触发任务：</p><ol><li>当光照强度大于1024Lux时，关闭电灯。</li><li>当光照强度小于1024Lux时，打开电灯。</li><li>至于光照强度等于1024Lux时，也打开电灯。</li></ol><p>注意，这里的1024Lux是我自己选择的一个值，你可以根据房屋情况自己调整。</p><h3 id="联动设备准备"><a aria-hidden="true" tabindex="-1" href="/blog-other/物联网开发实战/05.实战篇/04#联动设备准备"><span class="icon icon-link"></span></a>联动设备准备</h3><p>如果你还没有在小程序中添加光照传感器设备，这时可以打开微信中的腾讯连连小程序，扫描上面云平台“设备调试”中保存的那个二维码，添加光照传感器测试设备“Lightsensor_1”。</p><p>现在你的小程序里面已经有了两个设备，如下图所示。</p><p><img src="/blog-other/static/httpsstatic001geekbangorgresourceimage6ca26c9d5793b7b42e26151315bfc4865ea2.155c46c6.png" alt="19.14"/></p><p>刚才我们已经在腾讯云物联网平台上，为光照传感器设置了“智能联动配置”。现在，我们来为智能电灯配置智能联动能力。</p><p>我们进入智能电灯的“交互开发”页面，打开下面的“智能联动配置”页面，然后，像下图显示的那样，把“电灯开关”的“作为任务”条件勾选上。</p><p><img src="/blog-other/static/httpsstatic001geekbangorgresourceimage0e2e0ef30835ec3fa62c4968117c3f81372e.884b9ea0.png" alt="19.15"/></p><h3 id="联动任务创建"><a aria-hidden="true" tabindex="-1" href="/blog-other/物联网开发实战/05.实战篇/04#联动任务创建"><span class="icon icon-link"></span></a>联动任务创建</h3><p>然后，我们进入腾讯连连小程序，点击下面的“+”，选择“添加智能”，开始配置工作。</p><p><img src="/blog-other/static/httpsstatic001geekbangorgresourceimage9689965f2898374796898f59bd8ff4774b89.d36a909e.png" alt="19.16"/></p><p>我们从弹框里选择“自动智能”，可以看到下图的配置界面：</p><p><img src="/blog-other/static/httpsstatic001geekbangorgresourceimage419f4112709af28b0a9a20f340035f85a09f.3d17d967.png" alt="19.17"/></p><p>首先，我们添加条件，选择光照传感器设备，然后就会看到光照度属性。我们先设置大于1024Lux的条件。</p><p><img src="/blog-other/static/httpsstatic001geekbangorgresourceimagef24ef23b76ed4df0352295754d09845a384e.4f03e9f5.png" alt="19.18"/></p><p>然后，我们添加任务，选择智能电灯设备后，可以看到电灯开关的属性，选择“关”，点击保存。</p><p><img src="/blog-other/static/httpsstatic001geekbangorgresourceimage6beb6bd677fe4e4d404ce547d47446c3f4eb.864f6f66.png" alt="19.19"/></p><p>这时，我们可以看到这个智能联动的条件和任务已经配置完成。腾讯连连小程序还支持配置“生效时间段”，可以限定智能联动在选定的时间段内运行。</p><p><img src="/blog-other/static/httpsstatic001geekbangorgresourceimage9cb59cdc8bb22865540b5148572a1698d0b5.a1d187f7.png" alt="19.20"/></p><p>接下来，我们还可以设置一个主题图片和名称，这个根据喜好来就行了。</p><p><img src="/blog-other/static/httpsstatic001geekbangorgresourceimage859d856b5cc93cf8c90c22be43e5986ca69d.067b8d1a.png" alt=""/></p><p>按照相同的方法，我们可以设置其他两个条件，如下图所示：</p><p><img src="/blog-other/static/httpsstatic001geekbangorgresourceimagefa97fa1649f112046da7d44f0c5f5ede0c97.36a3095f.png" alt=""/></p><p>最终的智能联动，包括了刚才提到的3个不同的触发条件。</p><p><img src="/blog-other/static/httpsstatic001geekbangorgresourceimagee39de35a3byybe3148926bfe228e200f759d.915315ae.png" alt=""/></p><p>现在，你可以通过控制光照传感器的光照明暗（比如用手遮挡光敏元器件然后再把手拿开），来观察智能电灯的打开和关闭，检验功能是否正常。</p><h2 id="小结"><a aria-hidden="true" tabindex="-1" href="/blog-other/物联网开发实战/05.实战篇/04#小结"><span class="icon icon-link"></span></a>小结</h2><p>总结一下，在这一讲中，我介绍了利用树莓派打造网关，让光照传感器接入物联网平台的办法，并且带你实现了光照传感器和智能电灯的场景联动。你需要重点关注的内容有：</p><ol><li>为了实现协议转换，树莓派的南向接口，也就是蓝牙功能，你可以基于bluepy软件包开发。这里实现的功能是扫描光照传感器的广播包，并按照MiBeacon蓝牙协议解析出光照强度的数值。</li><li>北向接口要实现对接云平台的功能，这是基于MQTT协议实现的。你可以基于Eclipse paho的Python语言版本来开发MQTT Client的功能。</li><li>场景联动一般由条件和任务组成。其中，条件和任务是从我们的设备中定义的智能联动配置中选择的。</li></ol><p>为了避免光照的短暂变化，导致智能电灯的忽明忽暗，我将光照传感器的数据上报间隔设置得比较长。如果你有特殊的需求，可以修改光照传感器和网关程序中的参数来实现。</p><p>下一讲，我将讲解智能音箱的实现，并通过智能音箱控制智能电灯的开关。</p><h2 id="思考题"><a aria-hidden="true" tabindex="-1" href="/blog-other/物联网开发实战/05.实战篇/04#思考题"><span class="icon icon-link"></span></a>思考题</h2><p>最后，我给你留一个动手实践题。</p><p>在这一讲的场景联动中，我们实现了光照强度对电灯打开和关闭的自动控制。你可以通过光照强度的不同数值实现对智能电灯亮度，或者颜色的控制吗？</p><p>你可以动手设置一下，并且在留言区和我分享你的成果，同时，也欢迎你将这一讲分享给你的朋友，大家一起讨论学习。</p></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/GGwujun/blog/edit/master/ssrc/物联网开发实战/05.实战篇/04.md">在 GitHub 上编辑此页<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="最后更新时间：">2023/9/23 21:58:31</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script>
      (function () {
        if (!location.port) {
          (function (i, s, o, g, r, a, m) {
            i["GoogleAnalyticsObject"] = r;
            (i[r] =
              i[r] ||
              function () {
                (i[r].q = i[r].q || []).push(arguments);
              }),
              (i[r].l = 1 * new Date());
            (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m);
          })(
            window,
            document,
            "script",
            "//www.google-analytics.com/analytics.js",
            "ga"
          );
          ga("create", "UA-149864185-1", "auto");
          ga("send", "pageview");
        }
      })();
    </script>
    <script src="/blog-other/umi.js"></script>
  </body>
</html>
